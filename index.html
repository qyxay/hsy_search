
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>狐拾一搜索引擎</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: {
            colors: {
                // --- 颜色修改点 1: 将主色调修改为浅绿色 ---
                primary: '#10B981', // 这是一个清新的浅绿色
                secondary: '#64748B',
                accent: '#F59E0B',
                success: '#10B981',
                zhihu: {
                    blue: '#0F88EB',
                    red: '#F43530',
                    gray: '#8C8C8C',
                    // --- 颜色修改点 2: 将知乎背景色修改为浅绿色调 ---
                    light: '#F0FDF4' // 一个非常浅的绿色
                },
                data: {
                    key: '#047857', // 深一点的绿色，用于数据键名
                    string: '#059669',
                    number: '#D97706',
                    boolean: '#7C3AED',
                    null: '#6B7280'
                }
            },
            fontFamily: {
                sans: ['Inter', 'system-ui', 'sans-serif'],
                mono: ['Consolas', 'Monaco', 'monospace']
            },
            boxShadow: {
                'result': '0 1px 2px rgba(0,0,0,0.1)',
                'zhihu-card': '0 1px 4px rgba(0,0,0,0.08)',
                'zhihu-hover': '0 2px 8px rgba(0,0,0,0.12)',
                'data-block': '0 1px 3px rgba(0,0,0,0.05)'
            }
        }}}
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            /* --- 颜色修改点 3: 将搜索页面背景改为绿色渐变 --- */
            .search-engine-bg { @apply bg-white min-h-screen; }
            .zhihu-bg { @apply bg-white min-h-screen; }
            /* --- 颜色修改点 4: 将结果项背景改为浅绿色，并调整边框和阴影颜色 --- */
            .result-item { @apply bg-green-50/50 border border-green-100 rounded-lg p-4 hover:shadow-md transition-all duration-200 cursor-pointer; }
            .zhihu-card { @apply bg-green-50/50 rounded-lg shadow-zhihu-card hover:shadow-zhihu-hover transition-all duration-300; }
            .fade-in { animation: fadeIn 0.3s ease-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .slide-in { animation: slideIn 0.4s ease-out; }
            @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
            .highlight { @apply text-orange-400}
            .zhihu-author { @apply flex items-center gap-2 mb-3; }
            .zhihu-content { @apply text-gray-800 leading-relaxed; }
            .zhihu-footer { @apply flex items-center justify-between mt-0 pt-3 border-t border-gray-100; }
            .zhihu-action { @apply flex items-center gap-1 text-zhihu-gray hover:text-zhihu-red transition-colors duration-200 cursor-pointer; }
            .data-detail { @apply p-6 overflow-x-auto; }
            .data-key { @apply font-bold text-data-key mr-0 }
            .data-value-same { @apply text-gray-700; }
            .data-value-newline { @apply ml-4 block mt-1; }
            .source-tag { @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium; }
            .success-message { @apply bg-green-50 text-success border border-green-200; }
            /* --- 颜色修改点 5: 将返回按钮颜色改为新的主色调 --- */
            .back-button { @apply flex items-center text-primary hover:text-primary/80 transition-colors cursor-pointer; }
            .sync-status { @apply fixed bottom-4 right-4 px-3 py-1 text-xs rounded-full flex items-center gap-1 z-50; }
            .sync-pending { @apply bg-yellow-100 text-yellow-800; }
            .sync-success { @apply bg-green-100 text-green-800; }
            .sync-error { @apply bg-red-100 text-red-800; }
            /* 百度百科样式补充 */
            .baike-info-table { @apply w-full border-collapse mb-6; }
            .baike-info-th { @apply bg-green-50 w-1/4 text-left py-2 px-3 border border-green-100 font-bold text-gray-700; }
            .baike-info-td { @apply py-2 px-3 border border-green-100 text-gray-800; }
            /* --- 颜色修改点 6: 将百科标题下划线颜色改为主色调 --- */
            .baike-section-title { @apply text-xl font-bold text-gray-800 mb-0 pb-2 border-b-2 border-primary/20; }
            /* --- 颜色修改点 7: 将相关条目颜色改为主色调 --- */
            .baike-related-item { @apply inline-block bg-primary/10 text-primary px-2 py-1 rounded mr-2 mb-2 hover:bg-primary/20 transition-colors cursor-pointer no-underline; }
            
            /* 数据展示美化 */
            .data-container { @apply font-mono text-sm; }
            .data-padding { @apply p-0;}
            .data-object { @apply bg-white/50 rounded-lg p-4 pl-0 mb-2 shadow-data-block !m-0}
            .data-array { @apply bg-white/80 rounded-lg p-4 mb-2 shadow-data-block; }
            .data-expand-btn { @apply w-5 h-5 inline-flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors cursor-pointer mr-1 text-gray-500; }
            .data-type { @apply text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 mr-2; }
            .data-string { @apply text-data-string text-black; }
            .data-number { @apply text-data-number; }
            .data-boolean { @apply text-data-boolean; }
            .data-null { @apply text-data-null; }
            .data-indent { @apply pl-0 ml-1; }
            .data-pair { @apply mb-1.5 last:mb-0; }
            .shift-left {margin-left: -32px;}
            
            /* 一级内容大字显示 */
            .level-0-key { @apply text-lg font-bold; }
            .level-0-content { @apply mt-2 mb-4; }
            
            /* 句摘专用样式 */
            .quote-frame { @apply border border-gray-200 rounded-lg p-4 bg-white/50 mb-4; }
            .quote-tone { @apply text-gray-600 font-medium mb-1 inline-block; }
            .quote-content { @apply text-gray-800 leading-relaxed mb-2; }
            .quote-source { @apply text-gray-500 text-sm italic mt-1 pt-1 border-t border-gray-100; }
            /* 句摘区域专用样式 */
            .quote-section { @apply my-6; }
            .quote-section-title { @apply text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-primary/20; }
            .quote-list { @apply space-y-4; }
            
            /* 历史记录样式 */
            .history-container { @apply fixed top-0 right-0 w-80 h-full bg-white shadow-lg z-50 transform translate-x-full transition-transform duration-300 ease-in-out; }
            .history-container.open { @apply transform translate-x-0; }
            .history-header { @apply p-4 border-b border-gray-200 flex items-center justify-between; }
            .history-title { @apply text-lg font-bold text-gray-800; }
            .history-close { @apply text-gray-500 hover:text-gray-700 cursor-pointer; }
            .history-list { @apply p-4 max-h-[calc(100vh-120px)] overflow-y-auto; }
            .history-item { @apply p-3 border border-gray-100 rounded-lg mb-2 hover:bg-gray-50 cursor-pointer transition-colors; }
            .history-item.active { @apply bg-primary/10 border-primary/20; }
            .history-item-title { @apply font-medium text-gray-800 truncate; }
            .history-item-path { @apply text-xs text-gray-500 truncate; }
            .history-empty { @apply text-center py-8 text-gray-500; }
            .history-button { @apply fixed top-4 right-4 p-2 bg-white rounded-full shadow-md text-primary hover:bg-gray-50 transition-colors z-40; }
            .history-count { @apply absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center; }
        }
    </style>
</head>
<body id="appBody" class="search-engine-bg font-sans">

    <!-- 搜索页面布局 -->
    <div id="searchLayout" class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 搜索引擎标题 -->
        <div class="text-center mb-8">
            <!-- --- 颜色修改点 8: 将标题颜色改为新的主色调 --- -->
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary mb-2">狐拾一搜索</h1>
            <p class="text-secondary text-sm mb-4">狐拾一之异界神域</p>
        </div>

        <!-- 搜索框 -->
        <div class="mb-8 max-w-2xl mx-auto">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="输入关键词搜索..." 
                    class="w-full px-5 py-3 rounded-full border border-gray-250 focus:outline-none focus:border-primary focus:ring focus:ring-primary/20 transition-all text-lg">
                
                <!-- 清除按钮放在前面 -->
                <button id="clearBtn" onclick="clearSearch()" class="absolute p-10 right-20 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                    <i class="fa fa-times-circle text-xl"></i>
                </button>
                
                <!-- 搜索按钮放在后面 -->
                <!-- --- 颜色修改点 9: 将搜索按钮背景色改为新的主色调 --- -->
                <button id="searchBtn" onclick="executeSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-primary text-white px-6 py-2 rounded-full hover:bg-primary/90 transition-all">
                    <i class="fa fa-search mr-2"></i>搜索
                </button>
            </div>
        </div>


        <!-- 搜索状态 -->
        <div id="searchStatus" class="mb-6 text-center p-4 bg-blue-50 text-blue-700 rounded-lg hidden">
            <i class="fa fa-spinner fa-spin mr-2"></i><span id="searchStatusText">正在搜索...</span>
        </div>

        <!-- 成功提示 -->
        <div id="successMessage" class="mb-6 text-center p-4 success-message rounded-lg hidden">
            <i class="fa fa-check-circle mr-2"></i><span id="successText"></span>
        </div>

        <!-- 信息提示 -->
        <div id="infoMessage" class="mb-6 text-center p-4 bg-blue-50 text-blue-700 rounded-lg hidden">
            <i class="fa fa-info-circle mr-2"></i><span id="infoText"></span>
        </div>

        <!-- 搜索结果统计 -->
        <div id="resultStats" class="mb-6 text-sm text-gray-500 hidden">
            找到 <span id="resultCount" class="text-primary font-semibold">0</span> 条结果
        </div>

        <!-- 搜索结果列表 -->
        <div id="searchResults" class="space-y-3 hidden">
            <!-- 结果项将通过JavaScript动态生成 -->
        </div>

        <!-- 无结果提示 -->
        <div id="noResult" class="text-center py-12 bg-white rounded-lg border border-gray-100 hidden">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 text-gray-400 mb-4">
                <i class="fa fa-search text-2xl"></i>
            </div>
            <p class="text-gray-600 text-lg mb-2">未找到相关结果</p>
            <p class="text-gray-400 text-sm">建议：1. 简化关键词 2. 尝试同义词 3. 扩大搜索范围</p>
        </div>

        <!-- 错误提示 -->
        <div id="errorMessage" class="mb-6 p-4 bg-red-50 text-red-600 rounded-lg hidden">
            <i class="fa fa-exclamation-circle mr-2"></i><span id="errorText"></span>
        </div>
    </div>

    <!-- 百度百科式详情页面 -->
    <div id="zhihuLayout" class="hidden max-w-3xl mx-auto px-4 py-8">
        <!-- 返回按钮 -->
        <div class="flex justify-start items-center mb-6">
            <div id="backBtn" onclick="switchToSearchView()" class="back-button">
                <i class="fa fa-arrow-left mr-2"></i>返回搜索结果
            </div>
        </div>

        <!-- 详情内容（百度百科样式） -->
        <div id="detailContent" class="zhihu-card p-6">
            <!-- 内容将通过JavaScript动态生成 -->
        </div>

        <!-- 相关推荐 -->
        <div id="relatedContent" class="mt-8">
            <h3 class="baike-section-title">相关推荐</h3>
            <div id="relatedList" class="space-y-3">
                <!-- 相关内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 历史记录侧边栏 -->
    <div id="historyContainer" class="history-container">
        <div class="history-header">
            <div class="history-title">浏览历史</div>
            <div class="history-close" onclick="toggleHistory()">
                <i class="fa fa-times"></i>
            </div>
        </div>
        <div id="historyList" class="history-list">
            <!-- 历史记录列表 -->
        </div>
        <div class="p-4 border-t border-gray-200">
            <button onclick="clearHistory()" class="w-full py-2 text-sm text-gray-600 hover:text-red-500 transition-colors">
                <i class="fa fa-trash mr-2"></i>清空历史记录
            </button>
        </div>
    </div>

    <!-- 历史记录按钮 -->
    <div id="historyButton" class="history-button" onclick="toggleHistory()">
        <i class="fa fa-history text-xl"></i>
        <span id="historyCount" class="history-count hidden">0</span>
    </div>

    <script>
        
        console.log('狐拾一搜索引擎初始化...');
        
        // 集成JSON格式整理工具
        const githubJsonUtils = {
            jsonFormatter: {
                format(json, indent = 2) {
                    try {
                        const parsed = typeof json === 'string' ? JSON.parse(json) : json;
                        return JSON.stringify(parsed, null, indent);
                    } catch (error) {
                        throw new Error(`JSON格式化失败：${error.message}`);
                    }
                },

                minify(json) {
                    try {
                        const parsed = typeof json === 'string' ? JSON.parse(json) : json;
                        return JSON.stringify(parsed);
                    } catch (error) {
                        throw new Error(`JSON压缩失败：${error.message}`);
                    }
                },

                validate(jsonString) {
                    try {
                        JSON.parse(jsonString);
                        return { valid: true, error: null };
                    } catch (error) {
                        return { valid: false, error: error.message };
                    }
                },

                repair(jsonString) {
                    try {
                        let fixed = jsonString
                            .replace(/'/g, '"')
                            .replace(/,\s*([\]}])/g, '$1');
                        const validation = this.validate(fixed);
                        if (validation.valid) return fixed;
                        throw new Error(validation.error);
                    } catch (error) {
                        throw new Error(`JSON修复失败：${error.message}`);
                    }
                }
            }
        };

        const CONFIG = {
            dataUrl: 'https://qyxay.github.io/hsy_search/%E8%B5%84%E6%96%99%E5%BA%93.json',
            excludedPath: ['person'],
            maxDisplayLevel: 2,
            fetchTimeout: 20000,
            searchResultMaxLength: 70,
            // --- 颜色修改点 10: 将标签颜色改为绿色系 ---
            tagColors: [
                'bg-green-100 text-green-800',
                'bg-emerald-100 text-emerald-800',
                'bg-teal-100 text-teal-800',
                'bg-lime-100 text-lime-800',
                'bg-green-200 text-green-900',
                'bg-emerald-200 text-emerald-900',
                'bg-teal-200 text-teal-900',
                'bg-lime-200 text-lime-900'
            ],
            excludeHighlightPaths: [
                ['神域那些事', '尘夔惊天一战']
            ],
            maxHistoryItems: 30 // 最大历史记录条数
        };

        const STATE = {
            data: null,
            isSearching: false,
            lastQuery: '',
            searchResults: [],
            currentView: 'search',
            currentItem: null,
            rootTags: new Map(),
            loading: false,
            expandedNodes: new Set(), // 用于跟踪展开的节点
            searchCallback: null, // 用于搜索完成后的回调
            history: [] // 浏览历史记录
        };

        // DOM元素缓存
        const DOM = {
            appBody: document.getElementById('appBody'),
            searchLayout: document.getElementById('searchLayout'),
            zhihuLayout: document.getElementById('zhihuLayout'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            clearBtn: document.getElementById('clearBtn'),
            searchStatus: document.getElementById('searchStatus'),
            searchStatusText: document.getElementById('searchStatusText'),
            successMessage: document.getElementById('successMessage'),
            successText: document.getElementById('successText'),
            infoMessage: document.getElementById('infoMessage'),
            infoText: document.getElementById('infoText'),
            resultStats: document.getElementById('resultStats'),
            resultCount: document.getElementById('resultCount'),
            searchTime: document.getElementById('searchTime'),
            searchResults: document.getElementById('searchResults'),
            noResult: document.getElementById('noResult'),
            errorMessage: document.getElementById('errorMessage'),
            errorText: document.getElementById('errorText'),
            backBtn: document.getElementById('backBtn'),
            detailContent: document.getElementById('detailContent'),
            relatedContent: document.getElementById('relatedContent'),
            relatedList: document.getElementById('relatedList'),
            syncStatus: document.getElementById('syncStatus'),
            historyContainer: document.getElementById('historyContainer'),
            historyList: document.getElementById('historyList'),
            historyButton: document.getElementById('historyButton'),
            historyCount: document.getElementById('historyCount')
        };

        console.log('DOM元素缓存完成');

        // 工具函数：处理换行符
        function replaceNewlines(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/\n/g, '<br>&nbsp;&nbsp;&nbsp;');
        }

        function showError(message, duration = 5000) {
            console.error('错误:', message);
            if (DOM.errorText && DOM.errorMessage) {
                DOM.errorText.textContent = message;
                DOM.errorMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (DOM.errorMessage) DOM.errorMessage.classList.add('hidden');
                }, duration);
            }
        }

        function showSuccess(message, duration = 3000) {
            console.log('成功:', message);
            if (DOM.successText && DOM.successMessage) {
                DOM.successText.textContent = message;
                DOM.successMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (DOM.successMessage) DOM.successMessage.classList.add('hidden');
                }, duration);
            }
        }

        function showInfo(message, duration = 5000) {
            console.log('信息:', message);
            if (DOM.infoText && DOM.infoMessage) {
                DOM.infoText.textContent = message;
                DOM.infoMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (DOM.infoMessage) DOM.infoMessage.classList.add('hidden');
                }, duration);
            }
        }

        function hideAllMessages() {
            if (DOM.searchStatus) DOM.searchStatus.classList.add('hidden');
            if (DOM.successMessage) DOM.successMessage.classList.add('hidden');
            if (DOM.infoMessage) DOM.infoMessage.classList.add('hidden');
            if (DOM.noResult) DOM.noResult.classList.add('hidden');
            if (DOM.errorMessage) DOM.errorMessage.classList.add('hidden');
        }

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightMatch(text, query, pathParts = null) {
            if (!query || typeof text !== 'string') return text;
            
            if (pathParts && shouldExcludeHighlight(pathParts)) {
                return text;
            }
            
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            // 确保关键字匹配结果在前且为黑体
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function shouldExcludeHighlight(pathParts) {
            if (!pathParts || pathParts.length === 0) return false;
            
            return CONFIG.excludeHighlightPaths.some(excludePath => {
                if (excludePath.length > pathParts.length) return false;
                for (let i = 0; i < excludePath.length; i++)
                    if (pathParts[i] !== excludePath[i]) return false;
                return true;
            });
        }

        // 生成唯一节点ID
        function generateNodeId(path) {
            return path.join('-').replace(/\[|\]/g, '');
        }

        // 切换节点展开/折叠状态
        function toggleNode(nodeId) {
            console.log('toggleNode called with:', nodeId);
            if (STATE.expandedNodes.has(nodeId)) {
                STATE.expandedNodes.delete(nodeId);
            } else {
                STATE.expandedNodes.add(nodeId);
            }
            
            // 重新渲染当前详情页
            if (STATE.currentItem) {
                console.log('Re-rendering with expanded nodes:', Array.from(STATE.expandedNodes));
                renderZhihuDetail(STATE.currentItem);
            }
        }

        // 初始化第一层标签
        function initRootTags(data) {
            console.log('初始化第一层标签...');
            if (!data || typeof data !== 'object' || data === null) return;
            
            const rootKeys = Object.keys(data);
            rootKeys.forEach((key, index) => {
                const colorIndex = index % CONFIG.tagColors.length;
                STATE.rootTags.set(key, CONFIG.tagColors[colorIndex]);
            });
            
            console.log('第一层标签初始化完成:', Array.from(STATE.rootTags.entries()));
        }

        // 获取第一层标签
        function getRootTag(path) {
            if (!path || path.length === 0) return '';
            
            const firstPart = path[0];
            if (STATE.rootTags.has(firstPart)) {
                const bgColor = STATE.rootTags.get(firstPart);
                return `<span class="source-tag ${bgColor} mr-2">${firstPart}</span>`;
            }
            
            return '';
        }

        // 格式化搜索结果内容
        function formatSearchResultContent(obj, query, pathParts) {
            try {
                if (obj === null || obj === undefined) return '';
                
                if (typeof obj === 'object') {
                    let contentParts = [];
                    
                    if (Array.isArray(obj)) {
                        contentParts.push('[');
                        for (let i = 0; i < Math.min(obj.length, 3); i++) {
                            const item = obj[i];
                            if (typeof item === 'string') {
                                // 处理搜索结果中的换行
                                const processedItem = replaceNewlines(item);
                                contentParts.push(`"${processedItem.length > 10 ? processedItem.substring(0, 10) + '...' : processedItem}"`);
                            } else if (typeof item === 'object' && item !== null) {
                                contentParts.push('{...}');
                            } else {
                                contentParts.push(String(item));
                            }
                        }
                        if (obj.length > 3) contentParts.push('...');
                        contentParts.push(']');
                        return contentParts.join(', ');
                    } else {
                        const keys = Object.keys(obj);
                        for (const key of keys) {
                            const value = obj[key];
                            let valueStr = '';
                            
                            if (typeof value === 'string') {
                                // 处理搜索结果中的换行
                                valueStr = replaceNewlines(value);
                            } else if (typeof value === 'object' && value !== null) {
                                valueStr = JSON.stringify(value);
                            } else {
                                valueStr = String(value);
                            }
                            
                            contentParts.push(`${key}: ${valueStr}`);
                        }
                        
                        let fullContent = contentParts.join('  ');
                        if (fullContent.length > CONFIG.searchResultMaxLength) {
                            fullContent = fullContent.substring(0, CONFIG.searchResultMaxLength) + '...';
                        }
                        
                        return highlightMatch(fullContent, query, pathParts);
                    }
                } else {
                    const text = String(obj);
                    // 处理搜索结果中的换行
                    const processedText = replaceNewlines(text);
                    const highlighted = highlightMatch(processedText, query, pathParts);
                    return text.length > CONFIG.searchResultMaxLength
                        ? `${highlighted.substring(0, CONFIG.searchResultMaxLength)}...`
                        : highlighted;
                }
            } catch (err) {
                console.error('格式化搜索结果失败:', err);
                return '';
            }
        }

        function isExcludedPath(path) {
            if (path.length < CONFIG.excludedPath.length) return false;
            for (let i = 0; i < CONFIG.excludedPath.length; i++)
                if (path[i] !== CONFIG.excludedPath[i]) return false;
            return true;
        }

        // 美化的数据渲染函数
        function renderDataAsHumanReadable(data, query, currentPath = [], level = 0) {
            try {
                const nodeId = generateNodeId(currentPath);
                const isExpanded = STATE.expandedNodes.has(nodeId) || level < 2; // 默认展开前两层
                console.log('renderDataAsHumanReadable - nodeId:', nodeId, 'isExpanded:', isExpanded);
                
                if (data === null || data === undefined) {
                    return `<span class="data-null">null</span>`;
                }
                
                // 基本类型处理
                if (typeof data !== 'object') {
                    let valueHtml, typeClass;
                    
                    if (typeof data === 'string') {
                        typeClass = 'data-string';
                        // 处理字符串中的换行并保留高亮
                        const processedData = replaceNewlines(data);
                        valueHtml = `<div class="shift-left">&nbsp;&nbsp;&nbsp;&nbsp;${highlightMatch(processedData, query, currentPath)}</div>`;
                    } else if (typeof data === 'number') {
                        typeClass = 'data-number';
                        valueHtml = String(data);
                    } else if (typeof data === 'boolean') {
                        typeClass = 'data-boolean';
                        valueHtml = String(data);
                    } else {
                        typeClass = '';
                        valueHtml = String(data);
                    }
                    
                    return `<span class="${typeClass}">${valueHtml}</span>`;
                }

                // 数组处理
                if (Array.isArray(data)) {
                    const arrayLength = data.length;
                    const arrayType = `<span class="data-type"></span>`;
                    const expandBtn = `<div class="data-expand-btn" onclick="toggleNode('${nodeId}')">${isExpanded ? '-' : '+'}</div>`;
                    
                    let content = '';
                    if (isExpanded) {
                        if (arrayLength === 0) {
                            content = '<span class="text-gray-400">空数组</span>';
                        } else {
                            content = '<div class="data-indent">';
                            data.forEach((item, index) => {
                                const newPath = [...currentPath, `[${index}]`];
                                content += `
                                    <div class="py-1 border-b border-gray-50 last:border-0">
                                        <div class="flex items-start">
                                            <span class="text-gray-500 mr-2">${index}:</span>
                                            <div class="flex-1">${renderDataAsHumanReadable(item, query, newPath, level + 1)}</div>
                                        </div>
                                    </div>
                                `;
                            });
                            content += '</div>';
                        }
                    } else {
                        content = `<span class="text-gray-500">点击展开查看 ${arrayLength} 项内容</span>`;
                    }
                    
                    // 一级数组使用特殊样式
                    const arrayClass = level === 0 ? 'level-0-content' : '';
                    return `
                        <div class="data-array ${arrayClass}">
                            ${content}
                        </div>
                    `;
                }

                // 对象处理
                const keys = Object.keys(data);
                const objectType = `<span class="data-type"></span>`;
                const expandBtn = `<div class="data-expand-btn" onclick="toggleNode('${nodeId}')">${isExpanded ? '-' : '+'}</div>`;
                
                let content = '';
                if (isExpanded) {
                    if (keys.length === 0) {
                        content = '<span class="text-gray-400">空对象</span>';
                    } else {
                        content = '<div class="data-indent">';
                        keys.forEach(key => {
                            const value = data[key];
                            const newPath = [...currentPath, key];
                            const highlightedKey = highlightMatch(key, query, newPath);
                            
                            content += `
                                <div class="data-pair py-1 border-b border-gray-100 last:border-0 !p-0">
                                    <div class="flex items-start">
                                        <span class="data-key mr-2">${highlightedKey}:</span>
                                        <div class="flex-1">${renderDataAsHumanReadable(value, query, newPath, level + 1)}</div>
                                    </div>
                                </div>
                            `;
                        });
                        content += '</div>';
                    }
                } else {
                    content = `<span class="text-gray-500">点击展开查看 ${keys.length} 个属性</span>`;
                }
                
                // 一级对象使用特殊样式
                const objectClass = level === 0 ? 'level-0-content' : '';
                return `
                    <div class="data-object ${objectClass} !p-0">
                        ${content}
                    </div>
                `;
            } catch (err) {
                console.error('渲染数据失败:', err);
                return '<span class="text-red-500">数据渲染失败</span>';
            }
        }

        // 数据加载
        async function loadData() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    throw new Error('数据加载超时');
                }, CONFIG.fetchTimeout);

                const response = await fetch(CONFIG.dataUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error(`服务器响应错误 (${response.status})`);
                STATE.data = await response.json();

                initRootTags(STATE.data);
                loadHistory(); // 加载保存的历史记录
                showSuccess('数据源加载成功，可以开始搜索');
                
            } catch (err) {
                console.error('数据加载失败:', err);
                showError(`数据加载失败：${err.message}`);
            }
        }

        // 搜索功能 - 限制只能搜索到2层内容
        function searchData(obj, query, results, path, level) {
            try {
                if (level > CONFIG.maxDisplayLevel || isExcludedPath(path) || obj === null || typeof obj !== 'object') return;

                if (level === CONFIG.maxDisplayLevel) {
                    const currentName = path[path.length - 1];
                    const nameLower = currentName.toLowerCase();
                    const queryLower = query.toLowerCase();

                    let matchScore = 0, nameMatched = false, contentMatched = false;

                    if (nameLower.includes(queryLower)) {
                        nameMatched = true;
                        matchScore = nameLower === queryLower ? 10 : nameLower.startsWith(queryLower) ? 8 : 5;
                    }

                    if (!nameMatched && typeof obj === 'object') {
                        const contentStr = JSON.stringify(obj).toLowerCase();
                        if (contentStr.includes(queryLower)) {
                            contentMatched = true;
                            matchScore = 3;
                        }
                    }

                    if (nameMatched || contentMatched) {
                        const fullPath = path.join(' > ');
                        const content = formatSearchResultContent(obj, query, path);
                        
                        results.push({
                            id: Date.now() + Math.random(),
                            name: currentName,
                            highlightedName: highlightMatch(currentName, query, path),
                            content: content,
                            path: fullPath,
                            pathParts: [...path],
                            highlightedPath: path.map((p, index) => {
                                return highlightMatch(p, query, path.slice(0, index + 1));
                            }).join(' > '),
                            level: level,
                            fullData: obj,
                            matchScore: matchScore,
                            matchType: nameMatched ? 'name' : 'content'
                        });
                    }
                }

                if (level < CONFIG.maxDisplayLevel) {
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => {
                            const arrayItemName = `${path.length > 0 ? path[path.length - 1] : 'root'}[${index}]`;
                            searchData(item, query, results, [...path, arrayItemName], level + 1);
                        });
                    } else if (typeof obj === 'object' && obj !== null) {
                        for (const key in obj) {
                            if (obj.hasOwnProperty(key)) {
                                searchData(obj[key], query, results, [...path, key], level + 1);
                            }
                        }
                    }
                }
            } catch (err) {
                console.error(`搜索错误（路径：${path.join('/')}）:`, err);
            }
        }

        // 视图切换
        function switchToSearchView() {
            console.log('切换到搜索视图');
            try {
                document.getElementById('appBody').className = 'search-engine-bg';
                document.getElementById('searchLayout').classList.remove('hidden');
                document.getElementById('zhihuLayout').classList.add('hidden');
                
                STATE.currentView = 'search';
                
                window.scrollTo(0, 0); // 即时滚动到顶部
                
            } catch (error) {
                console.error('切换视图时发生错误:', error);
                try {
                    window.location.hash = '#search';
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                } catch (backupError) {
                    console.error('备用方法也失败:', backupError);
                }
            }
        }

        function switchToZhihuView(item, scrollToTop = true) {
            console.log('切换到视图:', item.name);
            STATE.currentView = 'zhihu';
            STATE.currentItem = item;
            
            // 添加到历史记录
            addToHistory(item);
            
            document.getElementById('appBody').className = 'zhihu-bg';
            document.getElementById('searchLayout').classList.add('hidden');
            document.getElementById('zhihuLayout').classList.remove('hidden');
            
            renderZhihuDetail(item);
            renderRelatedContent(item);
            updateHistoryDisplay(); // 更新历史记录显示
            
            if (scrollToTop) {
                window.scrollTo(0, 0); // 即时滚动到顶部
            }
        }

        // 渲染搜索结果
        function renderSearchResults(results, query) {
            try {
                console.log('渲染搜索结果，共', results.length, '条');
                if (!DOM.searchResults) return;
                
                DOM.searchResults.innerHTML = '';
                
                if (results.length === 0) {
                    if (DOM.noResult) DOM.noResult.classList.remove('hidden');
                    // 执行搜索回调（如果有）
                    if (STATE.searchCallback) {
                        STATE.searchCallback(null);
                        STATE.searchCallback = null;
                    }
                    return;
                }

                results.forEach((item, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item fade-in';
                    resultItem.style.animationDelay = `${index * 50}ms`;
                    resultItem.dataset.id = item.id;
                    
                    const rootTag = getRootTag(item.pathParts);
                    
                    resultItem.innerHTML = `
                        <div class="space-y-2">
                            <div class="flex items-start justify-between">
                                <h3 class="text-lg font-semibold text-primary !--tw-ring-color:rgba(16, 16, 16, 0.5)">${rootTag}${item.highlightedName}</h3>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">${item.content}</p>
                        </div>
                    `;

                    resultItem.onclick = () => switchToZhihuView(item);
                    
                    DOM.searchResults.appendChild(resultItem);
                });

                // 执行搜索回调（如果有）
                if (STATE.searchCallback) {
                    STATE.searchCallback(results[0]);
                    STATE.searchCallback = null;
                }
            } catch (err) {
                console.error('渲染搜索结果失败:', err);
                showError('渲染搜索结果失败');
                // 执行搜索回调（如果有）
                if (STATE.searchCallback) {
                    STATE.searchCallback(null);
                    STATE.searchCallback = null;
                }
            }
        }

        // 获取相关条目HTML（使用<a>标签）
        function getRelatedItemsHtml(currentItem, query) {
            try {
                // 1. 从当前数据的“关于”字段获取内容，判断是否存在且有效
                const aboutData = currentItem?.fullData?.关于;
                if (!aboutData) return ''; // 无“关于”字段，返回空
                
                // 2. 处理“关于”字段的不同格式（数组/字符串）
                let relatedList = [];
                if (Array.isArray(aboutData)) {
                    // 格式1：数组（如 ["条目1", "条目2"]）
                    relatedList = aboutData.filter(item => typeof item === 'string' && item.trim());
                } else if (typeof aboutData === 'string') {
                    // 处理换行符
                    const processedAbout = replaceNewlines(aboutData);
                    // 格式2：字符串（如 “相关：条目1, 条目2”），简单分割为数组
                    relatedList = processedAbout.replace(/^相关：|相关:/, '').split(',').map(item => item.trim()).filter(item => item);
                }
                
                // 3. 无有效相关内容，返回空
                if (relatedList.length === 0) return '';
                
                // 4. 生成带高亮的相关条目HTML，使用<a>标签
                    
                return relatedList.map(item => {
                    const highlightedItem = highlightMatch(item, query); // 保留关键词高亮
                    return `
                        <a href="javascript:void(0);" class="baike-related-item" onclick="searchByRelatedItem('${item.replace(/'/g, "\\'")}')">
                            ${highlightedItem}
                        </a>
                    `;
                }).join('');
            } catch (err) {
                console.error('处理“关于”字段失败:', err);
                return '';
            }
        }
        

        // 点击相关条目触发搜索并跳转到第一个结果
        function searchByRelatedItem(keyword) {
            // 设置搜索回调函数
            STATE.searchCallback = function(firstResult) {
                if (firstResult) {
                    // 移除延迟，直接跳转
                    switchToZhihuView(firstResult);
                }
            };
            
            DOM.searchInput.value = keyword;
            executeSearch();
            switchToSearchView(); // 跳回搜索页展示结果
        }

        // 渲染百度百科格式详情
        function renderZhihuDetail(item) {
            try {
                console.log('渲染百度百科详情:', item.name);
                if (!DOM.detailContent) return;
                
                const rootTag = getRootTag(item.pathParts);
                const relatedHtml = getRelatedItemsHtml(item, STATE.lastQuery);
                
                // 提取句摘数据（支持单个或多个句摘）
                const quotes = [];
                // 检查是否有单个句摘
                if (item.fullData?.句摘?.内容 && item.fullData?.句摘?.语气 && item.fullData?.句摘?.出处) {
                    quotes.push(item.fullData.句摘);
                }
                // 检查是否有句摘数组（如果未来支持多个）
                else if (Array.isArray(item.fullData?.句摘)) {
                    item.fullData.句摘.forEach(q => {
                        if (q?.内容 && q?.语气 && q?.出处) quotes.push(q);
                    });
                }
                
                // 生成句摘区域HTML（仅当有句摘时显示）
                const quoteSectionHtml = quotes.length > 0 ? `
                    <div class="quote-section">
                        <h3 class="quote-section-title">经典语录</h3>
                        <div class="quote-list">
                            ${quotes.map(quote => `
                                <div class="quote-frame">
                                    <div class="quote-content">&nbsp;&nbsp;&nbsp;&nbsp;${highlightMatch(replaceNewlines(quote.内容), STATE.lastQuery)} (${highlightMatch(quote.语气, STATE.lastQuery)})</div>
                                    <div class="quote-source">—— ${highlightMatch(quote.出处, STATE.lastQuery)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                // 从详细内容中移除句摘（避免重复显示）
                const dataWithoutQuotes = JSON.parse(JSON.stringify(item.fullData));
                if (dataWithoutQuotes.句摘) delete dataWithoutQuotes.句摘;
                if (dataWithoutQuotes.关于) delete dataWithoutQuotes.关于;
                const cleanedHumanReadableData = renderDataAsHumanReadable(dataWithoutQuotes, STATE.lastQuery, item.pathParts);
                
                // 检查数据是否为表格类型
                let infoTableHtml = '';
                const isTableType = typeof dataWithoutQuotes === 'object' && 
                                   dataWithoutQuotes !== null && 
                                   !Array.isArray(dataWithoutQuotes) && 
                                   (dataWithoutQuotes.表格 !== undefined || dataWithoutQuotes.table !== undefined);
                
                if (isTableType) {
                    const entries = Object.entries(dataWithoutQuotes);
                    if (entries.length > 0) {
                        infoTableHtml = '<table class="baike-info-table">';
                        entries.slice(0, 6).forEach(([key, value]) => {
                            const highlightedKey = highlightMatch(key, STATE.lastQuery);
                            // 处理表格内容中的换行
                            const valueStr = typeof value === 'object' ? JSON.stringify(value) : replaceNewlines(String(value));
                            const highlightedValue = highlightMatch(valueStr.length > 50 ? valueStr.substring(0, 50) + '...' : valueStr, STATE.lastQuery);
                            infoTableHtml += `
                                <tr>
                                    <th class="baike-info-th">${highlightedKey}</th>
                                    <td class="baike-info-td">${highlightedValue}</td>
                                </tr>
                            `;
                        });
                        if (entries.length > 6) {
                            infoTableHtml += `
                                <tr>
                                    <th class="baike-info-th">更多属性</th>
                                    <td class="baike-info-td text-gray-500">
                                        共 ${entries.length} 个属性，详见下方详细内容
                                    </td>
                                </tr>
                            `;
                        }
                        infoTableHtml += '</table>';
                    }
                }
                
                DOM.detailContent.innerHTML = `
                    <div class="space-y-6">
                        <!-- 标题和标签 -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <h2 class="text-2xl font-bold text-gray-800">${item.highlightedName}</h2>
                            ${rootTag}
                        </div>
                        
                        <!-- 作者信息 -->
                        <div class="zhihu-author">
                            <div class="flex items-center gap-2">
                                <!-- --- 颜色修改点 11: 将作者头像背景色改为新的主色调 --- -->
                                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-semibold">
                                    ${item.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-800">狐拾一之异界神域</div>
                                    <div class="text-xs text-zhihu-gray">当前时间 ${new Date().toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 百度百科式基本信息栏 -->
                        ${infoTableHtml}
                        
                        <!-- 概述部分 -->
                        <div>
                            <h3 class="baike-section-title">概述</h3>
                            <p class="text-gray-700 leading-relaxed">
                                &nbsp;&nbsp;&nbsp;&nbsp;${(() => {
                                    let introText = "关于" + item.highlightedName + "的基本介绍，包含核心特征和重要信息。";
                                    
                                    if (typeof dataWithoutQuotes === 'object' && dataWithoutQuotes !== null) {
                                        if (dataWithoutQuotes.介绍 !== undefined && typeof dataWithoutQuotes.介绍 === 'string') {
                                            // 处理概述中的换行
                                            introText = replaceNewlines(dataWithoutQuotes.介绍);
                                            introText = highlightMatch(introText, STATE.lastQuery);
                                        } else if (dataWithoutQuotes.description !== undefined && typeof dataWithoutQuotes.description === 'string') {
                                            // 处理概述中的换行
                                            introText = replaceNewlines(dataWithoutQuotes.description);
                                            introText = highlightMatch(introText, STATE.lastQuery);
                                        } else if (typeof dataWithoutQuotes === 'string') {
                                            // 处理概述中的换行
                                            introText = replaceNewlines(dataWithoutQuotes.substring(0, 150));
                                            introText = highlightMatch(introText, STATE.lastQuery);
                                            if (dataWithoutQuotes.length > 150) introText += '...';
                                        }
                                    }
                                    
                                    return introText;
                                })()}
                            </p>
                        </div>
                        
                        <!-- 新增：句摘区域 -->
                        ${quoteSectionHtml}
                        
                        <!-- 详细内容部分（已移除句摘） - 添加了"详细内容"标题 -->
                        <div>
                            <h3 class="baike-section-title">详细内容</h3>
                            <div class="data-detail data-container data-padding">
                                ${cleanedHumanReadableData}
                            </div>
                        </div>
                        
                        <!-- 相关条目：仅当有内容时渲染 -->
                        ${relatedHtml ? `
                            <div>
                                <h3 class="baike-section-title">相关条目</h3>
                                <div>
                                    ${relatedHtml}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- 操作区域 -->
                        <div class="zhihu-footer !m-0">
                            <div class="flex gap-6">
                                <div class="zhihu-action" onclick="switchToSearchView()">
                                    <i class="fa fa-arrow-left"></i>
                                    <span>返回</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('渲染失败:', err);
                if (DOM.detailContent) {
                    DOM.detailContent.innerHTML = '<div class="text-red-500 text-center py-8">数据渲染失败</div>';
                }
            }
        }

        // 渲染相关推荐
        function renderRelatedContent(currentItem) {
            try {
                console.log('渲染相关推荐');
                if (!DOM.relatedList) return;
                
                DOM.relatedList.innerHTML = '';
                
                const relatedItems = STATE.searchResults
                    .filter(item => item.id !== currentItem.id)
                    .slice(0, 5);

                relatedItems.forEach(item => {
                    const relatedItem = document.createElement('div');
                    relatedItem.className = 'zhihu-card p-4 cursor-pointer hover:bg-gray-50 transition-colors';
                    
                    const rootTag = getRootTag(item.pathParts);
                    
                    relatedItem.innerHTML = `
                        <div class="space-y-2">
                            <h4 class="font-medium text-gray-800 line-clamp-2">${rootTag}${item.highlightedName}</h4>
                        </div>
                    `;

                    relatedItem.onclick = () => switchToZhihuView(item, true);
                    
                    DOM.relatedList.appendChild(relatedItem);
                });
            } catch (err) {
                console.error('渲染相关推荐失败:', err);
            }
        }

        // 执行搜索
        async function executeSearch() {
            try {
                console.log('执行搜索...');
                if (STATE.isSearching) {
                    console.log('正在搜索中，忽略重复请求');
                    return;
                }
                if (!STATE.data) {
                    showError('数据源尚未加载完成，请稍候');
                    return;
                }

                const query = document.getElementById('searchInput').value.trim();
                if (!query) {
                    hideAllMessages();
                    if (DOM.clearBtn) DOM.clearBtn.classList.add('hidden');
                    STATE.lastQuery = '';
                    return;
                }

                if (query === STATE.lastQuery) {
                    showError('已搜索过此关键词');
                    return;
                }

                STATE.isSearching = true;
                STATE.lastQuery = query;
                hideAllMessages();
                
                if (DOM.searchStatus && DOM.searchStatusText) {
                    DOM.searchStatus.classList.remove('hidden');
                    DOM.searchStatusText.textContent = '正在搜索...';
                }

                const startTime = Date.now();
                const results = [];
                searchData(STATE.data, query, results, [], 0);
                const searchTime = (Date.now() - startTime) / 1000;

                results.sort((a, b) => b.matchScore - a.matchScore);
                STATE.searchResults = results;

                if (DOM.resultCount && DOM.searchTime && DOM.resultStats) {
                    DOM.resultCount.textContent = results.length;
                    DOM.searchTime.textContent = searchTime.toFixed(2);
                    DOM.resultStats.classList.remove('hidden');
                }
                
                if (DOM.searchResults) {
                    DOM.searchResults.classList.remove('hidden');
                }
                
                renderSearchResults(results, query);

                if (results.length === 0 && DOM.noResult) {
                    DOM.noResult.classList.remove('hidden');
                }

            } catch (err) {
                console.error('搜索失败:', err);
                showError(`搜索失败：${err.message}`);
            } finally {
                STATE.isSearching = false;
                if (DOM.searchStatus) {
                    DOM.searchStatus.classList.add('hidden');
                }
                if (DOM.clearBtn) {
                    DOM.clearBtn.classList.remove('hidden');
                }
            }
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearBtn').classList.add('hidden');
            hideAllMessages();
            STATE.lastQuery = '';
        }

        function updateHistoryDisplay() {
            try {
                // 更新历史记录数量显示
                if (DOM.historyCount) {
                    // 无论是否有记录，先更新文本内容
                    DOM.historyCount.textContent = STATE.history.length;
                    
                    // 根据数量决定是否显示
                    if (STATE.history.length > 0) {
                        DOM.historyCount.classList.remove('hidden');
                    } else {
                        DOM.historyCount.classList.add('hidden');
                    }
                }
                
                // 如果历史记录侧边栏是打开的，重新渲染
                if (DOM.historyContainer?.classList.contains('open')) {
                    renderHistoryList();
                }
                
            } catch (err) {
                console.error('更新历史记录显示失败:', err);
            }
        }

        // 历史记录功能
        function addToHistory(item) {
            try {
                console.log('添加到历史记录:', item.name);
                
                // 检查是否已经在历史记录中
                const existingIndex = STATE.history.findIndex(h => 
                    h.id === item.id || 
                    (h.name === item.name && h.path === item.path)
                );
                
                if (existingIndex > -1) {
                    // 如果已经存在，移除旧的记录
                    STATE.history.splice(existingIndex, 1);
                }
                
                // 添加新记录到最前面
                STATE.history.unshift({
                    ...item,
                    timestamp: new Date().toISOString()
                });
                
                // 限制历史记录数量
                if (STATE.history.length > CONFIG.maxHistoryItems) {
                    STATE.history = STATE.history.slice(0, CONFIG.maxHistoryItems);
                }
                
                // 保存到本地存储
                saveHistory();
                console.log('历史记录添加成功，当前历史记录数:', STATE.history.length);
                
            } catch (err) {
                console.error('添加历史记录失败:', err);
            }
        }

        function saveHistory() {
            try {
                // 只保存必要的信息以减少存储
                const historyToSave = STATE.history.map(item => ({
                    id: item.id,
                    name: item.name,
                    path: item.path,
                    pathParts: item.pathParts,
                    timestamp: item.timestamp,
                    fullData: item.fullData // 保存完整数据
                }));
                
                localStorage.setItem('hushi_search_history', JSON.stringify(historyToSave));
                console.log('历史记录保存成功');
            } catch (err) {
                console.error('保存历史记录失败:', err);
            }
        }

        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem('hushi_search_history');
                if (savedHistory) {
                    STATE.history = JSON.parse(savedHistory);
                    console.log('历史记录加载成功，共', STATE.history.length, '条');
                    updateHistoryDisplay();
                }
            } catch (err) {
                console.error('加载历史记录失败:', err);
                // 如果加载失败，清空历史记录
                STATE.history = [];
                localStorage.removeItem('hushi_search_history');
            }
        }

        function clearHistory() {
            try {
                STATE.history = [];
                localStorage.removeItem('hushi_search_history');
                showSuccess('历史记录已清空');
                console.log('历史记录清空成功');
                
                // 强制更新计数显示
                if (DOM.historyCount) {
                    DOM.historyCount.textContent = '0';
                    DOM.historyCount.classList.add('hidden');
                }
                
                updateHistoryDisplay();
            } catch (err) {
                console.error('清空历史记录失败:', err);
                showError('清空历史记录失败');
            }
        }

        

        function renderHistoryList() {
            try {
                if (!DOM.historyList) return;
                
                if (STATE.history.length === 0) {
                    DOM.historyList.innerHTML = `
                        <div class="history-empty">
                            <i class="fa fa-clock-o text-2xl mb-2 text-gray-400"></i>
                            <p>暂无浏览历史</p>
                            <p class="text-xs">浏览词条后会在这里显示</p>
                        </div>
                    `;
                    return;
                }
                
                DOM.historyList.innerHTML = STATE.history.map((item, index) => {
                    const isActive = STATE.currentItem && item.id === STATE.currentItem.id;
                    const rootTag = getRootTag(item.pathParts);
                    const date = new Date(item.timestamp);
                    const formattedDate = `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    return `
                        <div class="history-item ${isActive ? 'active' : ''}" onclick="loadFromHistory(${index})">
                            <div class="history-item-title">${rootTag}${item.name}</div>
                            <div class="history-item-path">${item.path}</div>
                            <div class="text-xs text-gray-400 mt-1">${formattedDate}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('渲染历史记录列表失败:', err);
                DOM.historyList.innerHTML = `
                    <div class="history-empty text-red-500">
                        <p>历史记录加载失败</p>
                    </div>
                `;
            }
        }

        function loadFromHistory(index) {
            try {
                if (index >= 0 && index < STATE.history.length) {
                    const item = STATE.history[index];
                    console.log('从历史记录加载:', item.name);
                    
                    // 关闭历史记录侧边栏
                    toggleHistory();
                    
                    // 切换到详情页
                    switchToZhihuView(item);
                }
            } catch (err) {
                console.error('从历史记录加载失败:', err);
                showError('加载历史记录失败');
            }
        }

        function toggleHistory() {
            try {
                if (DOM.historyContainer) {
                    DOM.historyContainer.classList.toggle('open');
                    
                    // 如果打开，渲染历史记录列表
                    if (DOM.historyContainer.classList.contains('open')) {
                        renderHistoryList();
                    }
                }
            } catch (err) {
                console.error('切换历史记录显示失败:', err);
            }
        }

        // 初始化事件
        function initEvents() {
            console.log('初始化事件...');
            
            // 搜索框回车事件
            if (DOM.searchInput) {
                DOM.searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        executeSearch();
                        DOM.searchInput.blur();
                    }
                });
            }

            // 输入框变化
            if (DOM.searchInput && DOM.clearBtn) {
                DOM.searchInput.addEventListener('input', function() {
                    DOM.clearBtn.classList.toggle('hidden', !DOM.searchInput.value.trim());
                });
            }

            // 点击页面其他地方关闭历史记录侧边栏
            document.addEventListener('click', function(e) {
                if (DOM.historyContainer && DOM.historyButton && 
                    !DOM.historyContainer.contains(e.target) && 
                    !DOM.historyButton.contains(e.target) &&
                    DOM.historyContainer.classList.contains('open')) {
                    toggleHistory();
                }
            });

            console.log('事件监听器初始化完成');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面DOM加载完成');
            
            initEvents();
            loadData();
            
        });

        // 全局函数
        window.switchToSearchView = switchToSearchView;
        window.executeSearch = executeSearch;
        window.clearSearch = clearSearch;
        window.toggleNode = toggleNode;
        window.searchByRelatedItem = searchByRelatedItem;
        window.addToHistory = addToHistory;
        window.clearHistory = clearHistory;
        window.toggleHistory = toggleHistory;
        window.loadFromHistory = loadFromHistory;

        console.log('JavaScript代码加载完成');
    </script>
</body>
</html>
