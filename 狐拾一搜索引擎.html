<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>狐拾一搜索</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/v4-shims.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#6B7280',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                        dark: {
                            primary: '#3B82F6',
                            secondary: '#9CA3AF',
                            background: '#1F2937',
                            card: '#374151'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'bounce-gentle': 'bounceGentle 0.6s ease-out',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.1);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes bounceGentle {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .highlight {
            background-color: #FFE066;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* 深色模式滚动条 */
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        /* 加载动画 */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #165DFF;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 评论输入框 */
        .comment-input {
            resize: none;
            min-height: 80px;
        }
        
        /* 点赞按钮动画 */
        .like-button {
            transition: all 0.2s ease;
        }
        
        .like-button:hover {
            transform: scale(1.1);
        }
        
        .like-button.liked {
            color: #EF4444;
            animation: bounceGentle 0.6s ease-out;
        }
    </style>
</head>

<body class="min-h-screen font-inter bg-gray-50 transition-colors duration-300 dark:bg-gray-900">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-lg dark:bg-gray-800 dark:shadow-gray-700/20 transition-all duration-300 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fa fa-search text-white text-lg"></i>
                        </div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">狐拾一搜索</h1>
                    </div>
                    <div class="hidden md:flex items-center space-x-1 text-sm text-gray-500 dark:text-gray-400">
                        <span>神秘世界数据库</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- 主题切换按钮 -->
                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                        <i class="fa fa-moon-o dark:hidden text-gray-600"></i>
                        <i class="fa fa-sun-o hidden dark:block text-yellow-400"></i>
                    </button>
                    <!-- 帮助按钮 -->
                    <button id="helpButton" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                        <i class="fa fa-question-circle text-gray-600 dark:text-gray-400"></i>
                    </button>
                    <!-- 同步状态 -->
                    <div id="syncStatus" class="flex items-center space-x-1 text-sm text-gray-500 dark:text-gray-400 hidden">
                        <div class="loading-spinner w-4 h-4 border-2 border-gray-300 border-t-primary"></div>
                        <span>同步中...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 搜索区域 -->
        <div class="mb-8 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 dark:bg-gray-800 dark:shadow-gray-700/20 card-hover">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="搜索神秘世界的一切... 支持高级语法：精确匹配""、必须包含+、排除词-、分类限定category:"
                            class="w-full px-4 py-3 pl-12 pr-4 text-gray-900 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 transition-all duration-300"
                        >
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <i class="fa fa-search"></i>
                        </div>
                        <button id="clearSearch" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hidden">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <button id="searchButton" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 focus:ring-4 focus:ring-primary/30 transition-all duration-300 font-medium flex items-center space-x-2">
                            <i class="fa fa-search"></i>
                            <span>搜索</span>
                        </button>
                        <button id="advancedSearchButton" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-300 font-medium flex items-center space-x-2">
                            <i class="fa fa-sliders"></i>
                            <span class="hidden md:inline">高级</span>
                        </button>
                    </div>
                </div>
                
                <!-- 搜索统计 -->
                <div id="searchStats" class="mt-4 flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400 hidden">
                    <div class="flex items-center space-x-1">
                        <i class="fa fa-clock-o"></i>
                        <span>搜索时间: <span id="searchTime">0</span>ms</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fa fa-database"></i>
                        <span>找到 <span id="resultCount">0</span> 个结果</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fa fa-tags"></i>
                        <span>分类: <span id="categoryStats"></span></span>
                    </div>
                </div>
                
                <!-- 热门搜索 -->
                <div id="hotSearches" class="mt-4 hidden">
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">热门搜索:</div>
                    <div id="hotSearchesList" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>

        <!-- 搜索结果 -->
        <div id="searchResults" class="space-y-6 hidden">
            <!-- 结果将在这里动态生成 -->
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="text-center py-16 animate-fade-in">
            <div class="w-24 h-24 mx-auto mb-6 opacity-20 dark:opacity-10">
                <i class="fa fa-search text-gray-400 text-6xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">开始你的探索</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">输入关键词，探索神秘世界的一切</p>
            <div class="flex justify-center space-x-4">
                <button class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-all duration-300 font-medium" onclick="document.getElementById('searchInput').focus()">
                    开始搜索
                </button>
                <button class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-300 font-medium" onclick="showHelp()">
                    查看帮助
                </button>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loadingState" class="text-center py-16 hidden">
            <div class="loading-spinner mx-auto mb-6"></div>
            <p class="text-gray-600 dark:text-gray-400">正在搜索神秘世界...</p>
        </div>

        <!-- 错误状态 -->
        <div id="errorState" class="text-center py-16 hidden">
            <div class="w-24 h-24 mx-auto mb-6 opacity-20 dark:opacity-10">
                <i class="fa fa-exclamation-triangle text-red-400 text-6xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">搜索失败</h3>
            <p id="errorMessage" class="text-gray-600 dark:text-gray-400 mb-6">无法连接到神秘世界数据库</p>
            <button class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-all duration-300 font-medium" onclick="retrySearch()">
                重试搜索
            </button>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto dark:bg-gray-800 animate-slide-up">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">搜索帮助</h2>
                    <button id="closeHelpModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">基本搜索</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">输入关键词即可搜索，支持以下高级语法：</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center space-x-2">
                            <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded dark:bg-gray-700 dark:text-gray-300">"精确匹配"</code>
                            <span class="text-gray-600 dark:text-gray-400">搜索精确短语</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded dark:bg-gray-700 dark:text-gray-300">+必须包含</code>
                            <span class="text-gray-600 dark:text-gray-400">结果必须包含该词</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded dark:bg-gray-700 dark:text-gray-300">-排除词</code>
                            <span class="text-gray-600 dark:text-gray-400">结果不包含该词</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded dark:bg-gray-700 dark:text-gray-300">category:分类</code>
                            <span class="text-gray-600 dark:text-gray-400">限定搜索分类</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">互动功能</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        <p><i class="fa fa-heart text-red-500 mr-2"></i>点击心形图标为喜欢的内容点赞</p>
                        <p><i class="fa fa-comment text-blue-500 mr-2"></i>点击评论图标查看和添加评论</p>
                        <p><i class="fa fa-star text-yellow-500 mr-2"></i>点击星星图标收藏感兴趣的内容</p>
                        <p><i class="fa fa-share text-green-500 mr-2"></i>点击分享图标分享内容到其他平台</p>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">数据同步</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        所有互动数据（点赞、评论、收藏）都会自动同步到云端，确保您在不同设备上都能看到相同的内容。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 评论模态框 -->
    <div id="commentModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden dark:bg-gray-800 animate-slide-up">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h2 id="commentModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">评论</h2>
                    <button id="closeCommentModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- 评论列表 -->
            <div id="commentsList" class="flex-1 overflow-y-auto p-6 max-h-[40vh]">
                <!-- 评论将在这里动态生成 -->
            </div>
            
            <!-- 评论输入 -->
            <div class="p-6 border-t border-gray-200 dark:border-gray-700">
                <div class="space-y-4">
                    <textarea 
                        id="commentInput" 
                        placeholder="写下你的评论..."
                        class="comment-input w-full px-4 py-3 text-gray-900 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 transition-all duration-300"
                    ></textarea>
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <span id="commentCharCount">0</span>/500 字符
                        </div>
                        <button id="submitComment" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 focus:ring-4 focus:ring-primary/30 transition-all duration-300 font-medium flex items-center space-x-2">
                            <i class="fa fa-paper-plane"></i>
                            <span>发表评论</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置信息
        const CONFIG = {
            dataUrl: 'https://qyxay.github.io/hsy_search/%E8%B5%84%E6%96%99%E5%BA%93.json',
            excludedPath: ['person'],
            maxDisplayLevel: 5,
            fetchTimeout: 15000,
            searchResultMaxLength: 70,
            tagColors: [
                'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
                'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400',
                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
                'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400',
                'bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-400',
                'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400',
                'bg-teal-100 text-teal-800 dark:bg-teal-900/30 dark:text-teal-400'
            ],
            excludeHighlightPaths: [
                ['神域那些事', '尘夔惊天一战']
            ],
            enableDebug: true
        };

        // 全局变量
        let appData = null;
        let currentSearchResults = [];
        let currentCategoryStats = {};
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

        // GitHub配置信息
        const GITHUB_CONFIG = {
            username: 'qyxay',
            repo: 'hsy_search',
            filePath: '互动信息.json',
            branch: 'main',
            token: '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'
        };

        /**
         * 互动数据管理器 - 用于处理用户点赞和评论数据的存储和同步
         */
        class InteractionDataManager {
            constructor() {
                // GitHub 配置信息
                this.githubConfig = GITHUB_CONFIG;
                
                // 本地存储键
                this.localStorageKey = 'hsy_interaction_data';
                this.fileShaKey = 'hsy_file_sha';
                
                // 数据结构
                this.interactionData = {
                    categories: {},
                    lastSync: Date.now()
                };
                
                // 文件SHA值（用于更新文件）
                this.fileSha = localStorage.getItem(this.fileShaKey) || null;
                
                // 初始化
                this.init();
            }
            
            /**
             * 初始化 - 从本地或GitHub加载数据
             */
            async init() {
                try {
                    // 先尝试从本地加载数据
                    this.loadFromLocalStorage();
                    
                    // 然后尝试从GitHub同步最新数据
                    await this.syncFromGitHub();
                    
                    console.log('互动数据管理器初始化完成');
                } catch (error) {
                    console.error('互动数据管理器初始化失败:', error);
                }
            }
            
            /**
             * 从本地存储加载数据
             */
            loadFromLocalStorage() {
                try {
                    const localData = localStorage.getItem(this.localStorageKey);
                    if (localData) {
                        this.interactionData = JSON.parse(localData);
                        console.log('从本地存储加载数据成功');
                    }
                } catch (error) {
                    console.error('从本地存储加载数据失败:', error);
                }
            }
            
            /**
             * 保存数据到本地存储
             */
            saveToLocalStorage() {
                try {
                    this.interactionData.lastSync = Date.now();
                    localStorage.setItem(this.localStorageKey, JSON.stringify(this.interactionData));
                    console.log('数据已保存到本地存储');
                } catch (error) {
                    console.error('保存数据到本地存储失败:', error);
                }
            }
            
            /**
             * 从GitHub加载数据
             */
            async loadFromGitHub() {
                try {
                    this.showSyncStatus(true);
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${this.githubConfig.username}/${this.githubConfig.repo}/contents/${this.githubConfig.filePath}?ref=${this.githubConfig.branch}`,
                        {
                            headers: {
                                'Authorization': `token ${this.githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.fileSha = data.sha;
                        localStorage.setItem(this.fileShaKey, this.fileSha);
                        
                        // 解码Base64内容
                        const decodedContent = decodeURIComponent(escape(atob(data.content)));
                        const githubData = JSON.parse(decodedContent);
                        
                        console.log('从GitHub加载数据成功');
                        return githubData;
                    } else if (response.status === 404) {
                        console.log('GitHub上文件不存在，将创建新文件');
                        return null;
                    } else {
                        throw new Error(`GitHub API请求失败: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('从GitHub加载数据失败:', error);
                    throw error;
                } finally {
                    this.showSyncStatus(false);
                }
            }
            
            /**
             * 保存数据到GitHub
             */
            async saveToGitHub() {
                try {
                    this.showSyncStatus(true);
                    
                    // 编码内容为Base64
                    const encodedContent = btoa(unescape(encodeURIComponent(JSON.stringify(this.interactionData, null, 2))));
                    
                    const requestData = {
                        message: `Update interaction data - ${new Date().toISOString()}`,
                        content: encodedContent,
                        branch: this.githubConfig.branch
                    };
                    
                    // 如果是更新文件，需要提供SHA
                    if (this.fileSha) {
                        requestData.sha = this.fileSha;
                    }
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${this.githubConfig.username}/${this.githubConfig.repo}/contents/${this.githubConfig.filePath}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${this.githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        }
                    );
                    
                    const responseData = await response.json();
                    
                    if (response.ok) {
                        this.fileSha = responseData.content.sha;
                        localStorage.setItem(this.fileShaKey, this.fileSha);
                        console.log('数据已保存到GitHub');
                        return true;
                    } else {
                        const errorMessage = responseData.message || `${response.status} ${response.statusText}`;
                        throw new Error(`保存到GitHub失败: ${errorMessage}`);
                    }
                } catch (error) {
                    console.error('保存数据到GitHub失败:', error);
                    throw error;
                } finally {
                    this.showSyncStatus(false);
                }
            }
            
            /**
             * 与GitHub同步数据
             */
            async syncFromGitHub() {
                try {
                    const githubData = await this.loadFromGitHub();
                    
                    if (githubData) {
                        // 合并数据 - 本地数据优先
                        this.interactionData = this.mergeData(githubData, this.interactionData);
                        this.saveToLocalStorage();
                        console.log('数据同步完成');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('数据同步失败:', error);
                    throw error;
                }
            }
            
            /**
             * 合并数据 - 本地数据优先
             */
            mergeData(githubData, localData) {
                // 创建新的合并对象
                const mergedData = {
                    categories: {},
                    lastSync: Date.now()
                };
                
                // 获取所有分类
                const allCategories = new Set([
                    ...Object.keys(githubData.categories || {}),
                    ...Object.keys(localData.categories || {})
                ]);
                
                // 合并每个分类
                for (const category of allCategories) {
                    mergedData.categories[category] = this.mergeCategory(
                        githubData.categories?.[category] || { items: {} },
                        localData.categories?.[category] || { items: {} }
                    );
                }
                
                return mergedData;
            }
            
            /**
             * 合并分类数据
             */
            mergeCategory(githubCategory, localCategory) {
                const mergedCategory = { items: {} };
                
                // 获取所有项目
                const allItems = new Set([
                    ...Object.keys(githubCategory.items || {}),
                    ...Object.keys(localCategory.items || {})
                ]);
                
                // 合并每个项目
                for (const itemPath of allItems) {
                    mergedCategory.items[itemPath] = this.mergeItem(
                        githubCategory.items?.[itemPath] || {},
                        localCategory.items?.[itemPath] || {}
                    );
                }
                
                return mergedCategory;
            }
            
            /**
             * 合并项目数据
             */
            mergeItem(githubItem, localItem) {
                const mergedItem = {
                    likesCount: localItem.likesCount || githubItem.likesCount || 0,
                    commentsCount: localItem.commentsCount || githubItem.commentsCount || 0,
                    commentsList: []
                };
                
                // 合并评论 - 按时间排序，去重
                const allComments = [
                    ...(githubItem.commentsList || []),
                    ...(localItem.commentsList || [])
                ];
                
                // 按时间排序并去重
                mergedItem.commentsList = Array.from(
                    new Map(allComments.map(comment => [comment.id, comment])).values()
                ).sort((a, b) => new Date(a.time) - new Date(b.time));
                
                // 更新评论计数
                mergedItem.commentsCount = mergedItem.commentsList.length;
                
                return mergedItem;
            }
            
            /**
             * 获取项目的互动数据
             */
            getItemInteraction(category, itemPath) {
                if (!this.interactionData.categories[category]) {
                    this.interactionData.categories[category] = { items: {} };
                }
                
                if (!this.interactionData.categories[category].items[itemPath]) {
                    this.interactionData.categories[category].items[itemPath] = {
                        likesCount: 0,
                        commentsCount: 0,
                        commentsList: []
                    };
                }
                
                return this.interactionData.categories[category].items[itemPath];
            }
            
            /**
             * 点赞功能
             */
            async toggleLike(category, itemPath) {
                try {
                    const itemData = this.getItemInteraction(category, itemPath);
                    itemData.likesCount += 1;
                    
                    this.saveToLocalStorage();
                    await this.saveToGitHub();
                    
                    console.log(`点赞成功 - ${category} > ${itemPath}`);
                    return itemData.likesCount;
                } catch (error) {
                    console.error('点赞失败:', error);
                    throw error;
                }
            }
            
            /**
             * 添加评论
             */
            async addComment(category, itemPath, content, author = '用户') {
                try {
                    const itemData = this.getItemInteraction(category, itemPath);
                    
                    const comment = {
                        id: Date.now(),
                        content: content,
                        author: author,
                        time: new Date().toISOString()
                    };
                    
                    itemData.commentsList.push(comment);
                    itemData.commentsCount = itemData.commentsList.length;
                    
                    this.saveToLocalStorage();
                    await this.saveToGitHub();
                    
                    console.log(`评论添加成功 - ${category} > ${itemPath}`);
                    return comment;
                } catch (error) {
                    console.error('添加评论失败:', error);
                    throw error;
                }
            }
            
            /**
             * 获取项目的评论列表
             */
            getComments(category, itemPath) {
                const itemData = this.getItemInteraction(category, itemPath);
                return [...itemData.commentsList]; // 返回副本，防止直接修改
            }
            
            /**
             * 获取项目的点赞数
             */
            getLikeCount(category, itemPath) {
                const itemData = this.getItemInteraction(category, itemPath);
                return itemData.likesCount;
            }
            
            /**
             * 获取项目的评论数
             */
            getCommentCount(category, itemPath) {
                const itemData = this.getItemInteraction(category, itemPath);
                return itemData.commentsCount;
            }
            
            /**
             * 手动同步数据
             */
            async manualSync() {
                try {
                    await this.syncFromGitHub();
                    await this.saveToGitHub();
                    console.log('手动同步完成');
                    return true;
                } catch (error) {
                    console.error('手动同步失败:', error);
                    throw error;
                }
            }
            
            /**
             * 显示同步状态
             */
            showSyncStatus(show) {
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.classList.toggle('hidden', !show);
                }
            }
        }

        // 初始化互动数据管理器
        const interactionManager = new InteractionDataManager();

        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        /**
         * 初始化应用
         */
        async function initializeApp() {
            try {
                showLoadingState();
                await loadData();
                showEmptyState();
                updateHotSearches();
                initializeTheme();
            } catch (error) {
                console.error('应用初始化失败:', error);
                showErrorState('应用初始化失败，请刷新页面重试');
            }
        }

        /**
         * 设置事件监听器
         */
        function setupEventListeners() {
            // 搜索相关
            document.getElementById('searchInput').addEventListener('input', handleSearchInput);
            document.getElementById('searchInput').addEventListener('keypress', handleSearchKeyPress);
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            document.getElementById('advancedSearchButton').addEventListener('click', showAdvancedSearch);

            // 主题切换
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // 帮助模态框
            document.getElementById('helpButton').addEventListener('click', showHelp);
            document.getElementById('closeHelpModal').addEventListener('click', closeHelpModal);

            // 评论模态框
            document.getElementById('closeCommentModal').addEventListener('click', closeCommentModal);
            document.getElementById('submitComment').addEventListener('click', submitComment);
            document.getElementById('commentInput').addEventListener('input', updateCommentCharCount);

            // 点击模态框背景关闭
            document.getElementById('helpModal').addEventListener('click', function(e) {
                if (e.target === this) closeHelpModal();
            });
            
            document.getElementById('commentModal').addEventListener('click', function(e) {
                if (e.target === this) closeCommentModal();
            });

            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + / 显示帮助
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    showHelp();
                }
                // ESC 关闭模态框
                if (e.key === 'Escape') {
                    closeHelpModal();
                    closeCommentModal();
                }
            });
        }

        /**
         * 加载数据
         */
        async function loadData() {
            try {
                const response = await Promise.race([
                    fetch(CONFIG.dataUrl),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('请求超时')), CONFIG.fetchTimeout)
                    )
                ]);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误，状态码: ${response.status}`);
                }
                
                appData = await response.json();
                console.log('数据加载成功:', appData);
                return appData;
            } catch (error) {
                console.error('数据加载失败:', error);
                throw error;
            }
        }

        /**
         * 执行搜索
         */
        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) {
                clearSearch();
                return;
            }
            
            try {
                showLoadingState();
                
                const startTime = performance.now();
                
                // 如果数据未加载或需要刷新，重新加载数据
                if (!appData) {
                    await loadData();
                }
                
                // 解析搜索查询
                const parsedQuery = parseSearchQuery(query);
                console.log('解析后的查询:', parsedQuery);
                
                // 执行搜索
                currentSearchResults = searchData(appData, parsedQuery);
                currentCategoryStats = calculateCategoryStats(currentSearchResults);
                
                const endTime = performance.now();
                const searchTime = Math.round(endTime - startTime);
                
                // 显示搜索结果
                displaySearchResults(currentSearchResults, searchTime);
                updateSearchStats(searchTime);
                addToSearchHistory(query);
                updateHotSearches();
                
                // 滚动到结果区域
                document.getElementById('searchResults').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
            } catch (error) {
                console.error('搜索失败:', error);
                showErrorState('搜索过程中发生错误，请重试');
            }
        }

        /**
         * 解析搜索查询
         */
        function parseSearchQuery(query) {
            const parsed = {
                exactPhrases: [],
                requiredWords: [],
                excludedWords: [],
                category: null,
                keywords: []
            };
            
            // 匹配精确短语 ""
            const exactMatchRegex = /"([^"]+)"/g;
            let match;
            while ((match = exactMatchRegex.exec(query)) !== null) {
                parsed.exactPhrases.push(match[1].toLowerCase());
            }
            
            // 移除精确短语部分
            let remainingQuery = query.replace(exactMatchRegex, '');
            
            // 匹配分类限定 category:xxx
            const categoryRegex = /\bcategory:(\w+)\b/g;
            while ((match = categoryRegex.exec(remainingQuery)) !== null) {
                parsed.category = match[1];
            }
            
            // 移除分类限定部分
            remainingQuery = remainingQuery.replace(categoryRegex, '');
            
            // 处理剩余的词
            const words = remainingQuery.trim().split(/\s+/);
            
            words.forEach(word => {
                if (word.startsWith('+')) {
                    parsed.requiredWords.push(word.substring(1).toLowerCase());
                } else if (word.startsWith('-')) {
                    parsed.excludedWords.push(word.substring(1).toLowerCase());
                } else if (word) {
                    parsed.keywords.push(word.toLowerCase());
                }
            });
            
            return parsed;
        }

        /**
         * 搜索数据
         */
        function searchData(data, query) {
            const results = [];
            
            // 递归搜索函数
            function recursiveSearch(currentData, path = [], currentLevel = 1) {
                if (currentLevel > CONFIG.maxDisplayLevel) {
                    return;
                }
                
                // 遍历当前层级的所有键
                for (const key in currentData) {
                    if (currentData.hasOwnProperty(key)) {
                        const newPath = [...path, key];
                        const value = currentData[key];
                        
                        // 检查是否需要排除这个路径
                        if (shouldExcludePath(newPath)) {
                            continue;
                        }
                        
                        // 检查是否匹配搜索条件
                        if (matchesSearch(value, key, newPath, query)) {
                            const result = createSearchResult(newPath, value, currentLevel);
                            results.push(result);
                        }
                        
                        // 如果是对象并且不是叶子节点，继续递归
                        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                            recursiveSearch(value, newPath, currentLevel + 1);
                        }
                    }
                }
            }
            
            // 开始递归搜索
            recursiveSearch(data);
            
            // 按匹配度排序
            results.sort((a, b) => b.score - a.score);
            
            return results;
        }

        /**
         * 检查是否应该排除路径
         */
        function shouldExcludePath(path) {
            return CONFIG.excludedPath.some(excluded => {
                if (typeof excluded === 'string') {
                    return path.includes(excluded);
                } else if (Array.isArray(excluded)) {
                    return excluded.every((item, index) => path[index] === item);
                }
                return false;
            });
        }

        /**
         * 检查是否匹配搜索条件
         */
        function matchesSearch(value, key, path, query) {
            // 如果指定了分类，先检查分类
            if (query.category) {
                const category = path[0] || '';
                if (!category.toLowerCase().includes(query.category.toLowerCase())) {
                    return false;
                }
            }
            
            // 转换值为字符串以便搜索
            const valueStr = JSON.stringify(value).toLowerCase();
            const keyStr = key.toLowerCase();
            const pathStr = path.join(' > ').toLowerCase();
            
            // 检查精确短语
            for (const phrase of query.exactPhrases) {
                if (!valueStr.includes(phrase) && !keyStr.includes(phrase) && !pathStr.includes(phrase)) {
                    return false;
                }
            }
            
            // 检查必须包含的词
            for (const word of query.requiredWords) {
                if (!valueStr.includes(word) && !keyStr.includes(word) && !pathStr.includes(word)) {
                    return false;
                }
            }
            
            // 检查排除的词
            for (const word of query.excludedWords) {
                if (valueStr.includes(word) || keyStr.includes(word) || pathStr.includes(word)) {
                    return false;
                }
            }
            
            // 如果没有关键词，只要通过了前面的检查就算匹配
            if (query.keywords.length === 0 && query.exactPhrases.length === 0) {
                return true;
            }
            
            // 检查关键词（只要匹配一个关键词即可）
            if (query.keywords.length > 0) {
                const matchesAnyKeyword = query.keywords.some(keyword => 
                    valueStr.includes(keyword) || keyStr.includes(keyword) || pathStr.includes(keyword)
                );
                
                if (!matchesAnyKeyword) {
                    return false;
                }
            }
            
            return true;
        }

        /**
         * 创建搜索结果
         */
        function createSearchResult(path, value, level) {
            let content = '';
            let score = 0;
            
            // 根据值的类型处理内容
            if (typeof value === 'string') {
                content = value;
                score += 2; // 字符串匹配权重更高
            } else if (typeof value === 'object' && value !== null) {
                // 如果是对象，尝试提取有意义的内容
                if (Object.keys(value).length === 0) {
                    content = '[空对象]';
                } else {
                    // 尝试找到第一个字符串值作为预览
                    const firstStringValue = findFirstStringValue(value);
                    content = firstStringValue || `[对象包含 ${Object.keys(value).length} 个属性]`;
                }
                score += 1;
            } else {
                content = String(value);
                score += 1;
            }
            
            // 根据层级调整分数（层级越浅分数越高）
            score += (CONFIG.maxDisplayLevel - level + 1) * 0.5;
            
            return {
                path: path,
                pathStr: path.join(' > '),
                category: path[0] || '未分类',
                key: path[path.length - 1],
                content: content,
                fullContent: value,
                level: level,
                score: score
            };
        }

        /**
         * 找到对象中的第一个字符串值
         */
        function findFirstStringValue(obj) {
            if (typeof obj === 'string') {
                return obj;
            }
            
            if (typeof obj === 'object' && obj !== null) {
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const result = findFirstStringValue(obj[key]);
                        if (result) {
                            return result;
                        }
                    }
                }
            }
            
            return null;
        }

        /**
         * 显示搜索结果
         */
        function displaySearchResults(results, searchTime) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('hidden');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-16 animate-fade-in">
                        <div class="w-24 h-24 mx-auto mb-6 opacity-20 dark:opacity-10">
                            <i class="fa fa-search text-gray-400 text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">未找到结果</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">尝试使用不同的关键词或搜索语法</p>
                        <button class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-300 font-medium" onclick="showHelp()">
                            查看搜索帮助
                        </button>
                    </div>
                `;
                return;
            }
            
            // 按分类分组显示
            const resultsByCategory = {};
            results.forEach(result => {
                if (!resultsByCategory[result.category]) {
                    resultsByCategory[result.category] = [];
                }
                resultsByCategory[result.category].push(result);
            });
            
            // 为每个分类创建结果区域
            Object.keys(resultsByCategory).forEach((category, categoryIndex) => {
                const categoryResults = resultsByCategory[category];
                
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white rounded-2xl shadow-lg p-6 dark:bg-gray-800 dark:shadow-gray-700/20 animate-slide-up';
                categoryCard.style.animationDelay = `${categoryIndex * 0.1}s`;
                
                // 获取分类颜色
                const colorClass = CONFIG.tagColors[categoryIndex % CONFIG.tagColors.length];
                
                categoryCard.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 ${colorClass.replace('text-', 'bg-').replace('dark:text-', 'dark:bg-')} rounded-full"></div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">${category}</h2>
                            <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm dark:bg-gray-700 dark:text-gray-300">
                                ${categoryResults.length} 个结果
                            </span>
                        </div>
                        <button onclick="toggleCategoryExpand('${category}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors duration-200">
                            <i class="fa fa-chevron-up text-sm"></i>
                        </button>
                    </div>
                    <div id="category-${category}" class="space-y-4">
                        ${categoryResults.map((result, index) => createResultItem(result, index)).join('')}
                    </div>
                `;
                
                resultsContainer.appendChild(categoryCard);
            });
        }

        /**
         * 创建结果项
         */
        function createResultItem(result, index) {
            // 高亮处理
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const highlightedPath = highlightText(result.pathStr, searchQuery);
            const highlightedContent = shouldExcludeHighlight(result.path) 
                ? result.content 
                : highlightText(result.content, searchQuery);
            
            // 截断内容
            const truncatedContent = truncateText(highlightedContent, CONFIG.searchResultMaxLength);
            
            // 获取互动数据
            const likeCount = interactionManager.getLikeCount(result.category, result.pathStr);
            const commentCount = interactionManager.getCommentCount(result.category, result.pathStr);
            
            // 检查是否为收藏
            const isFavorite = isItemFavorite(result.pathStr);
            
            return `
                <div class="border border-gray-200 rounded-xl p-4 hover:border-primary/30 hover:bg-primary/5 dark:border-gray-700 dark:hover:border-primary/50 dark:hover:bg-primary/10 transition-all duration-300 animate-slide-up card-hover" style="animation-delay: ${index * 0.05}s">
                    <div class="mb-2">
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white text-sm leading-relaxed">
                                ${highlightedPath}
                            </h3>
                            <div class="flex items-center space-x-1">
                                <button onclick="toggleFavorite('${result.pathStr}')" class="favorite-button p-1.5 text-gray-400 hover:text-yellow-500 dark:hover:text-yellow-400 transition-colors duration-200 ${isFavorite ? 'text-yellow-500 dark:text-yellow-400' : ''}">
                                    <i class="fa fa-star ${isFavorite ? 'fa-solid' : 'fa-regular'} text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-3">
                            ${truncatedContent}
                        </p>
                    </div>
                    
                    <!-- 互动按钮 -->
                    <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-700">
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleLike('${result.category}', '${result.pathStr}', this)" class="like-button flex items-center space-x-1 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors duration-200 px-2 py-1 rounded">
                                <i class="fa fa-heart text-sm"></i>
                                <span class="text-xs">${likeCount}</span>
                            </button>
                            <button onclick="openCommentModal('${result.category}', '${result.pathStr}', '${escapeHtml(result.pathStr)}')" class="flex items-center space-x-1 text-gray-500 hover:text-blue-500 dark:text-gray-400 dark:hover:text-blue-400 transition-colors duration-200 px-2 py-1 rounded">
                                <i class="fa fa-comment text-sm"></i>
                                <span class="text-xs">${commentCount}</span>
                            </button>
                            <button onclick="shareItem('${escapeHtml(result.pathStr)}')" class="flex items-center space-x-1 text-gray-500 hover:text-green-500 dark:text-gray-400 dark:hover:text-green-400 transition-colors duration-200 px-2 py-1 rounded">
                                <i class="fa fa-share text-sm"></i>
                                <span class="text-xs">分享</span>
                            </button>
                        </div>
                        <button onclick="showFullContent('${result.category}', '${result.pathStr}')" class="text-primary hover:text-primary/80 dark:text-primary/80 dark:hover:text-primary text-xs px-2 py-1 rounded hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors duration-200">
                            查看详情
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * 高亮文本中的搜索关键词
         */
        function highlightText(text, searchQuery) {
            if (!searchQuery || !text) return text;
            
            const parsedQuery = parseSearchQuery(searchQuery);
            const allKeywords = [...parsedQuery.keywords, ...parsedQuery.requiredWords, ...parsedQuery.exactPhrases];
            
            if (allKeywords.length === 0) return text;
            
            // 创建正则表达式，匹配所有关键词
            const regex = new RegExp(`(${allKeywords.map(keyword => escapeRegExp(keyword)).join('|')})`, 'gi');
            
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        /**
         * 检查是否应该排除高亮
         */
        function shouldExcludeHighlight(path) {
            return CONFIG.excludeHighlightPaths.some(excludePath => {
                if (excludePath.length !== path.length) return false;
                return excludePath.every((item, index) => path[index] === item);
            });
        }

        /**
         * 截断文本
         */
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            
            // 找到合适的截断位置
            const truncated = text.substring(0, maxLength);
            // 尝试在单词边界截断
            const lastSpaceIndex = truncated.lastIndexOf(' ');
            if (lastSpaceIndex > maxLength / 2) {
                return truncated.substring(0, lastSpaceIndex) + '...';
            }
            
            return truncated + '...';
        }

        /**
         * 转义HTML
         */
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        /**
         * 转义正则表达式特殊字符
         */
        function escapeRegExp(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        /**
         * 计算分类统计
         */
        function calculateCategoryStats(results) {
            const stats = {};
            results.forEach(result => {
                stats[result.category] = (stats[result.category] || 0) + 1;
            });
            return stats;
        }

        /**
         * 更新搜索统计
         */
        function updateSearchStats(searchTime) {
            const statsContainer = document.getElementById('searchStats');
            const searchTimeElement = document.getElementById('searchTime');
            const resultCountElement = document.getElementById('resultCount');
            const categoryStatsElement = document.getElementById('categoryStats');
            
            searchTimeElement.textContent = searchTime;
            resultCountElement.textContent = currentSearchResults.length;
            
            // 更新分类统计
            const categoryStats = Object.entries(currentCategoryStats)
                .map(([category, count]) => `${category}(${count})`)
                .join(', ');
            categoryStatsElement.textContent = categoryStats;
            
            statsContainer.classList.remove('hidden');
        }

        /**
         * 更新热门搜索
         */
        function updateHotSearches() {
            const hotSearchesContainer = document.getElementById('hotSearches');
            const hotSearchesList = document.getElementById('hotSearchesList');
            
            if (searchHistory.length === 0) {
                hotSearchesContainer.classList.add('hidden');
                return;
            }
            
            // 获取热门搜索（去重并排序）
            const searchFrequency = {};
            searchHistory.forEach(search => {
                searchFrequency[search] = (searchFrequency[search] || 0) + 1;
            });
            
            const hotSearches = Object.entries(searchFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([search, frequency]) => search);
            
            hotSearchesList.innerHTML = hotSearches.map(search => `
                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 cursor-pointer transition-colors duration-200" onclick="setSearchQuery('${escapeHtml(search)}')">
                    ${escapeHtml(search)}
                </span>
            `).join('');
            
            hotSearchesContainer.classList.remove('hidden');
        }

        /**
         * 添加到搜索历史
         */
        function addToSearchHistory(query) {
            if (!query) return;
            
            // 移除已存在的相同查询
            searchHistory = searchHistory.filter(item => item !== query);
            // 添加到历史记录开头
            searchHistory.unshift(query);
            // 限制历史记录长度
            if (searchHistory.length > 50) {
                searchHistory = searchHistory.slice(0, 50);
            }
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        /**
         * 设置搜索查询
         */
        function setSearchQuery(query) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = query;
            handleSearchInput();
            performSearch();
        }

        /**
         * 处理搜索输入
         */
        function handleSearchInput() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            if (searchInput.value.trim()) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }
        }

        /**
         * 处理搜索按键
         */
        function handleSearchKeyPress(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        }

        /**
         * 清除搜索
         */
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            handleSearchInput();
            showEmptyState();
        }

        /**
         * 显示高级搜索
         */
        function showAdvancedSearch() {
            showHelp();
        }

        /**
         * 显示帮助
         */
        function showHelp() {
            document.getElementById('helpModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        /**
         * 关闭帮助模态框
         */
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        /**
         * 点赞功能
         */
        async function toggleLike(category, itemPath, button) {
            try {
                const likeCount = await interactionManager.toggleLike(category, itemPath);
                
                // 更新UI
                const likeButton = button.closest('.like-button');
                const countSpan = likeButton.querySelector('span');
                
                likeButton.classList.add('liked');
                countSpan.textContent = likeCount;
                
                // 添加点赞动画
                setTimeout(() => {
                    likeButton.classList.remove('liked');
                }, 600);
                
                // 显示成功提示
                showToast('点赞成功！', 'success');
                
            } catch (error) {
                console.error('点赞失败:', error);
                showToast('点赞失败，请重试', 'error');
            }
        }

        /**
         * 打开评论模态框
         */
        async function openCommentModal(category, itemPath, title) {
            try {
                // 保存当前项目信息
                window.currentCommentItem = { category, itemPath };
                
                // 更新模态框标题
                document.getElementById('commentModalTitle').textContent = `评论 - ${title}`;
                
                // 清空评论输入
                document.getElementById('commentInput').value = '';
                updateCommentCharCount();
                
                // 加载评论
                await loadComments(category, itemPath);
                
                // 显示模态框
                document.getElementById('commentModal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // 聚焦到评论输入框
                setTimeout(() => {
                    document.getElementById('commentInput').focus();
                }, 100);
                
            } catch (error) {
                console.error('打开评论模态框失败:', error);
                showToast('加载评论失败，请重试', 'error');
            }
        }

        /**
         * 关闭评论模态框
         */
        function closeCommentModal() {
            document.getElementById('commentModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            window.currentCommentItem = null;
        }

        /**
         * 加载评论
         */
        async function loadComments(category, itemPath) {
            try {
                const commentsList = document.getElementById('commentsList');
                const comments = interactionManager.getComments(category, itemPath);
                
                if (comments.length === 0) {
                    commentsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <i class="fa fa-comment-o text-4xl mb-3 opacity-50"></i>
                            <p>还没有评论，快来抢沙发吧！</p>
                        </div>
                    `;
                    return;
                }
                
                commentsList.innerHTML = comments.map(comment => `
                    <div class="mb-4 p-4 bg-gray-50 rounded-xl dark:bg-gray-700/50 animate-slide-up">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center">
                                    <i class="fa fa-bullseye text-primary text-sm"></i>
                                </div>
                                <span class="font-medium text-gray-900 dark:text-white text-sm">${escapeHtml(comment.author)}</span>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${formatTime(comment.time)}</span>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">${escapeHtml(comment.content)}</p>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('加载评论失败:', error);
                throw error;
            }
        }

        /**
         * 提交评论
         */
        async function submitComment() {
            const commentInput = document.getElementById('commentInput');
            const content = commentInput.value.trim();
            
            if (!content) {
                showToast('请输入评论内容', 'warning');
                return;
            }
            
            if (content.length > 500) {
                showToast('评论内容不能超过500字符', 'warning');
                return;
            }
            
            if (!window.currentCommentItem) {
                showToast('评论失败，请重试', 'error');
                return;
            }
            
            try {
                const { category, itemPath } = window.currentCommentItem;
                
                // 添加评论
                const comment = await interactionManager.addComment(category, itemPath, content);
                
                // 清空输入框
                commentInput.value = '';
                updateCommentCharCount();
                
                // 重新加载评论
                await loadComments(category, itemPath);
                
                // 更新列表中的评论数
                const commentButtons = document.querySelectorAll(`[onclick="openCommentModal('${category}', '${itemPath}', '${escapeHtml(itemPath)}')"]`);
                commentButtons.forEach(button => {
                    const countSpan = button.querySelector('span');
                    const currentCount = parseInt(countSpan.textContent);
                    countSpan.textContent = currentCount + 1;
                });
                
                showToast('评论发表成功！', 'success');
                
            } catch (error) {
                console.error('提交评论失败:', error);
                showToast('评论发表失败，请重试', 'error');
            }
        }

        /**
         * 更新评论字符计数
         */
        function updateCommentCharCount() {
            const commentInput = document.getElementById('commentInput');
            const charCount = document.getElementById('commentCharCount');
            charCount.textContent = commentInput.value.length;
        }

        /**
         * 格式化时间
         */
        function formatTime(timeString) {
            const now = new Date();
            const time = new Date(timeString);
            const diff = now - time;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return '刚刚';
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            if (days < 30) return `${days}天前`;
            
            return time.toLocaleDateString();
        }

        /**
         * 收藏功能
         */
        function toggleFavorite(itemPath) {
            const isFavorite = isItemFavorite(itemPath);
            
            if (isFavorite) {
                // 取消收藏
                favorites = favorites.filter(fav => fav !== itemPath);
                showToast('已取消收藏', 'info');
            } else {
                // 添加收藏
                favorites.push(itemPath);
                showToast('收藏成功！', 'success');
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // 更新UI
            const favoriteButtons = document.querySelectorAll(`[onclick="toggleFavorite('${itemPath}')"]`);
            favoriteButtons.forEach(button => {
                const icon = button.querySelector('i');
                if (isFavorite) {
                    button.classList.remove('text-yellow-500', 'dark:text-yellow-400');
                    icon.classList.remove('fa-solid');
                    icon.classList.add('fa-regular');
                } else {
                    button.classList.add('text-yellow-500', 'dark:text-yellow-400');
                    icon.classList.remove('fa-regular');
                    icon.classList.add('fa-solid');
                }
            });
        }

        /**
         * 检查是否为收藏
         */
        function isItemFavorite(itemPath) {
            return favorites.includes(itemPath);
        }

        /**
         * 分享功能
         */
        function shareItem(itemPath) {
            try {
                if (navigator.share) {
                    navigator.share({
                        title: '狐拾一搜索',
                        text: `发现了一个有趣的内容：${itemPath}`,
                        url: window.location.href
                    });
                } else {
                    // 复制到剪贴板
                    const shareText = `狐拾一搜索 - ${itemPath}\n${window.location.href}`;
                    navigator.clipboard.writeText(shareText).then(() => {
                        showToast('链接已复制到剪贴板', 'success');
                    }).catch(() => {
                        // 降级到手动复制
                        const textArea = document.createElement('textarea');
                        textArea.value = shareText;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showToast('链接已复制到剪贴板', 'success');
                    });
                }
            } catch (error) {
                console.error('分享失败:', error);
                showToast('分享失败，请重试', 'error');
            }
        }

        /**
         * 显示完整内容
         */
        function showFullContent(category, itemPath) {
            try {
                // 在新窗口中显示完整内容
                const fullContent = findItemByPath(appData, itemPath.split(' > '));
                if (fullContent) {
                    const contentStr = typeof fullContent === 'object' 
                        ? JSON.stringify(fullContent, null, 2) 
                        : String(fullContent);
                    
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                            <head>
                                <title>${itemPath}</title>
                                <style>
                                    body { font-family: 'Inter', sans-serif; padding: 20px; line-height: 1.6; }
                                    .path { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #165DFF; }
                                    .content { white-space: pre-wrap; background: #f5f5f5; padding: 20px; border-radius: 8px; }
                                </style>
                            </head>
                            <body>
                                <div class="path">${escapeHtml(itemPath)}</div>
                                <div class="content">${escapeHtml(contentStr)}</div>
                            </body>
                        </html>
                    `);
                }
            } catch (error) {
                console.error('显示完整内容失败:', error);
                showToast('显示失败，请重试', 'error');
            }
        }

        /**
         * 根据路径查找项目
         */
        function findItemByPath(data, path) {
            let current = data;
            for (const part of path) {
                if (current && typeof current === 'object' && part in current) {
                    current = current[part];
                } else {
                    return null;
                }
            }
            return current;
        }

        /**
         * 切换分类展开/折叠
         */
        function toggleCategoryExpand(category) {
            const categoryContent = document.getElementById(`category-${category}`);
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            
            if (categoryContent.classList.contains('hidden')) {
                categoryContent.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                categoryContent.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        /**
         * 重试搜索
         */
        function retrySearch() {
            performSearch();
        }

        /**
         * 显示加载状态
         */
        function showLoadingState() {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('searchStats').classList.add('hidden');
            document.getElementById('hotSearches').classList.add('hidden');
        }

        /**
         * 显示空状态
         */
        function showEmptyState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('searchStats').classList.add('hidden');
            document.getElementById('hotSearches').classList.add('hidden');
        }

        /**
         * 显示错误状态
         */
        function showErrorState(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('searchStats').classList.add('hidden');
            document.getElementById('hotSearches').classList.add('hidden');
            
            if (message) {
                document.getElementById('errorMessage').textContent = message;
            }
        }

        /**
         * 显示提示消息
         */
        function showToast(message, type = 'info') {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300 ${getToastStyle(type)}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 显示提示
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // 隐藏提示
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        /**
         * 获取提示样式
         */
        function getToastStyle(type) {
            switch (type) {
                case 'success':
                    return 'bg-green-500 text-white';
                case 'error':
                    return 'bg-red-500 text-white';
                case 'warning':
                    return 'bg-yellow-500 text-white';
                default:
                    return 'bg-gray-800 text-white';
            }
        }

        /**
         * 初始化主题
         */
        function initializeTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        }

        /**
         * 切换主题
         */
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // 定期同步数据
        setInterval(() => {
            if (interactionManager && navigator.onLine) {
                interactionManager.manualSync().catch(console.error);
            }
        }, 300000); // 每5分钟自动同步一次

        // 网络状态变化时同步数据
        window.addEventListener('online', () => {
            if (interactionManager) {
                interactionManager.manualSync().catch(console.error);
            }
        });
    </script>
</body>

</html>
