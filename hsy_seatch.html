<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>狐拾一搜索引擎</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: {
            colors: {
                primary: '#1E40AF',
                secondary: '#64748B',
                accent: '#F59E0B',
                success: '#10B981',
                zhihu: {
                    blue: '#0F88EB',
                    red: '#F43530',
                    gray: '#8C8C8C',
                    light: '#F7F8FA'
                },
                data: {
                    key: '#1E40AF',
                    string: '#059669',
                    number: '#D97706',
                    boolean: '#7C3AED',
                    null: '#6B7280'
                }
            },
            fontFamily: {
                sans: ['Inter', 'system-ui', 'sans-serif'],
                mono: ['Consolas', 'Monaco', 'monospace']
            },
            boxShadow: {
                'result': '0 1px 2px rgba(0,0,0,0.1)',
                'zhihu-card': '0 1px 4px rgba(0,0,0,0.08)',
                'zhihu-hover': '0 2px 8px rgba(0,0,0,0.12)',
                'data-block': '0 1px 3px rgba(0,0,0,0.05)'
            }
        }}}
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .search-engine-bg { @apply bg-gradient-to-b from-white to-gray-50 min-h-screen; }
            .zhihu-bg { @apply bg-zhihu-light min-h-screen; }
            .result-item { @apply bg-white border border-gray-100 rounded-lg p-4 hover:shadow-md transition-all duration-200 cursor-pointer; }
            .zhihu-card { @apply bg-white rounded-lg shadow-zhihu-card hover:shadow-zhihu-hover transition-all duration-300; }
            .fade-in { animation: fadeIn 0.3s ease-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .slide-in { animation: slideIn 0.4s ease-out; }
            @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
            .highlight { @apply bg-yellow-100 text-black px-1 rounded; }
            .zhihu-author { @apply flex items-center gap-2 mb-3; }
            .zhihu-content { @apply text-gray-800 leading-relaxed; }
            .zhihu-footer { @apply flex items-center justify-between mt-4 pt-3 border-t border-gray-100; }
            .zhihu-action { @apply flex items-center gap-1 text-zhihu-gray hover:text-zhihu-red transition-colors duration-200 cursor-pointer; }
            .data-detail { @apply bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 overflow-x-auto; }
            .data-key { @apply font-bold text-data-key mr-2; }
            .data-value-same { @apply text-gray-700; }
            .data-value-newline { @apply ml-4 block mt-1; }
            .source-tag { @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium; }
            .success-message { @apply bg-green-50 text-success border border-green-200; }
            .back-button { @apply flex items-center text-zhihu-blue hover:text-zhihu-blue/80 transition-colors cursor-pointer; }
            .sync-status { @apply fixed bottom-4 right-4 px-3 py-1 text-xs rounded-full flex items-center gap-1 z-50; }
            .sync-pending { @apply bg-yellow-100 text-yellow-800; }
            .sync-success { @apply bg-green-100 text-green-800; }
            .sync-error { @apply bg-red-100 text-red-800; }
            /* 百度百科样式补充 */
            .baike-info-table { @apply w-full border-collapse mb-6; }
            .baike-info-th { @apply bg-gray-50 w-1/4 text-left py-2 px-3 border border-gray-200 font-bold text-gray-700; }
            .baike-info-td { @apply py-2 px-3 border border-gray-200 text-gray-800; }
            .baike-section-title { @apply text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-100; }
            .baike-related-item { @apply inline-block bg-blue-50 text-primary px-2 py-1 rounded mr-2 mb-2 hover:bg-blue-100 transition-colors cursor-pointer; }
            
            /* 数据展示美化 */
            .data-container { @apply font-mono text-sm; }
            .data-object { @apply bg-white rounded-lg p-4 mb-2 shadow-data-block; }
            .data-array { @apply bg-white rounded-lg p-4 mb-2 shadow-data-block; }
            .data-expand-btn { @apply w-5 h-5 inline-flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors cursor-pointer mr-1 text-gray-500; }
            .data-type { @apply text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 mr-2; }
            .data-string { @apply text-data-string; }
            .data-number { @apply text-data-number; }
            .data-boolean { @apply text-data-boolean; }
            .data-null { @apply text-data-null; }
            .data-indent { @apply pl-6 border-l-2 border-gray-100 ml-2; }
            .data-pair { @apply mb-1.5 last:mb-0; }
        }
    </style>
</head>
<body id="appBody" class="search-engine-bg font-sans">
    <!-- 同步状态指示器（已无实际作用，保留防止报错） -->
    <div id="syncStatus" class="sync-status hidden">
        <i class="fa fa-spinner fa-spin"></i>
        <span>同步中...</span>
    </div>

    <!-- 搜索页面布局 -->
    <div id="searchLayout" class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 搜索引擎标题 -->
        <div class="text-center mb-8">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary mb-2">狐拾一搜索</h1>
            <p class="text-secondary text-sm mb-4">狐拾一之异界神域</p>
        </div>

        <!-- 搜索框 -->
        <div class="mb-8 max-w-2xl mx-auto">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="输入关键词搜索..." 
                       class="w-full px-5 py-3 rounded-full border border-gray-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-lg">
                <button id="searchBtn" onclick="executeSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-primary text-white px-6 py-2 rounded-full hover:bg-primary/90 transition-all">
                    <i class="fa fa-search mr-2"></i>搜索
                </button>
                <button id="clearBtn" onclick="clearSearch()" class="absolute right-24 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                    <i class="fa fa-times-circle text-xl"></i>
                </button>
            </div>
        </div>

        <!-- 搜索状态 -->
        <div id="searchStatus" class="mb-6 text-center p-4 bg-blue-50 text-blue-700 rounded-lg hidden">
            <i class="fa fa-spinner fa-spin mr-2"></i><span id="searchStatusText">正在搜索...</span>
        </div>

        <!-- 成功提示 -->
        <div id="successMessage" class="mb-6 text-center p-4 success-message rounded-lg hidden">
            <i class="fa fa-check-circle mr-2"></i><span id="successText"></span>
        </div>

        <!-- 信息提示 -->
        <div id="infoMessage" class="mb-6 text-center p-4 bg-blue-50 text-blue-700 rounded-lg hidden">
            <i class="fa fa-info-circle mr-2"></i><span id="infoText"></span>
        </div>

        <!-- 搜索结果统计 -->
        <div id="resultStats" class="mb-6 text-sm text-gray-500 hidden">
            找到 <span id="resultCount" class="text-primary font-semibold">0</span> 条结果
        </div>

        <!-- 搜索结果列表 -->
        <div id="searchResults" class="space-y-3 hidden">
            <!-- 结果项将通过JavaScript动态生成 -->
        </div>

        <!-- 无结果提示 -->
        <div id="noResult" class="text-center py-12 bg-white rounded-lg border border-gray-100 hidden">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 text-gray-400 mb-4">
                <i class="fa fa-search text-2xl"></i>
            </div>
            <p class="text-gray-600 text-lg mb-2">未找到相关结果</p>
            <p class="text-gray-400 text-sm">建议：1. 简化关键词 2. 尝试同义词 3. 扩大搜索范围</p>
        </div>

        <!-- 错误提示 -->
        <div id="errorMessage" class="mb-6 p-4 bg-red-50 text-red-600 rounded-lg hidden">
            <i class="fa fa-exclamation-circle mr-2"></i><span id="errorText"></span>
        </div>
    </div>

    <!-- 百度百科式详情页面 -->
    <div id="zhihuLayout" class="hidden max-w-3xl mx-auto px-4 py-8">
        <!-- 返回按钮 -->
        <div class="flex justify-start items-center mb-6">
            <div id="backBtn" onclick="switchToSearchView()" class="back-button">
                <i class="fa fa-arrow-left mr-2"></i>返回搜索结果
            </div>
        </div>

        <!-- 详情内容（百度百科样式） -->
        <div id="detailContent" class="zhihu-card p-6">
            <!-- 内容将通过JavaScript动态生成 -->
        </div>

        <!-- 相关推荐 -->
        <div id="relatedContent" class="mt-8">
            <h3 class="baike-section-title">相关推荐</h3>
            <div id="relatedList" class="space-y-3">
                <!-- 相关内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        console.log('狐拾一搜索引擎初始化...');
        
        // 集成JSON格式整理工具
        const githubJsonUtils = {
            jsonFormatter: {
                format(json, indent = 2) {
                    try {
                        const parsed = typeof json === 'string' ? JSON.parse(json) : json;
                        return JSON.stringify(parsed, null, indent);
                    } catch (error) {
                        throw new Error(`JSON格式化失败：${error.message}`);
                    }
                },

                minify(json) {
                    try {
                        const parsed = typeof json === 'string' ? JSON.parse(json) : json;
                        return JSON.stringify(parsed);
                    } catch (error) {
                        throw new Error(`JSON压缩失败：${error.message}`);
                    }
                },

                validate(jsonString) {
                    try {
                        JSON.parse(jsonString);
                        return { valid: true, error: null };
                    } catch (error) {
                        return { valid: false, error: error.message };
                    }
                },

                repair(jsonString) {
                    try {
                        let fixed = jsonString
                            .replace(/'/g, '"')
                            .replace(/,\s*([\]}])/g, '$1');
                        const validation = this.validate(fixed);
                        if (validation.valid) return fixed;
                        throw new Error(validation.error);
                    } catch (error) {
                        throw new Error(`JSON修复失败：${error.message}`);
                    }
                }
            }
        };

        const CONFIG = {
            dataUrl: 'https://qyxay.github.io/hsy_search/%E8%B5%84%E6%96%99%E5%BA%93.json',
            excludedPath: ['person'],
            maxDisplayLevel: 2,
            fetchTimeout: 20000,
            searchResultMaxLength: 70,
            tagColors: [
                'bg-blue-100 text-blue-800',
                'bg-green-100 text-green-800',
                'bg-purple-100 text-purple-800',
                'bg-yellow-100 text-yellow-800',
                'bg-red-100 text-red-800',
                'bg-indigo-100 text-indigo-800',
                'bg-pink-100 text-pink-800',
                'bg-teal-100 text-teal-800',
                'bg-orange-100 text-orange-800',
                'bg-gray-100 text-gray-800'
            ],
            excludeHighlightPaths: [
                ['神域那些事', '尘夔惊天一战']
            ]
        };

        const STATE = {
            data: null,
            isSearching: false,
            lastQuery: '',
            searchResults: [],
            currentView: 'search',
            currentItem: null,
            rootTags: new Map(),
            loading: false,
            expandedNodes: new Set() // 用于跟踪展开的节点
        };

        // DOM元素缓存
        const DOM = {
            appBody: document.getElementById('appBody'),
            searchLayout: document.getElementById('searchLayout'),
            zhihuLayout: document.getElementById('zhihuLayout'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            clearBtn: document.getElementById('clearBtn'),
            searchStatus: document.getElementById('searchStatus'),
            searchStatusText: document.getElementById('searchStatusText'),
            successMessage: document.getElementById('successMessage'),
            successText: document.getElementById('successText'),
            infoMessage: document.getElementById('infoMessage'),
            infoText: document.getElementById('infoText'),
            resultStats: document.getElementById('resultStats'),
            resultCount: document.getElementById('resultCount'),
            searchTime: document.getElementById('searchTime'),
            searchResults: document.getElementById('searchResults'),
            noResult: document.getElementById('noResult'),
            errorMessage: document.getElementById('errorMessage'),
            errorText: document.getElementById('errorText'),
            backBtn: document.getElementById('backBtn'),
            detailContent: document.getElementById('detailContent'),
            relatedContent: document.getElementById('relatedContent'),
            relatedList: document.getElementById('relatedList'),
            syncStatus: document.getElementById('syncStatus')
        };

        console.log('DOM元素缓存完成');

        // 工具函数
        function showError(message, duration = 5000) {
            console.error('错误:', message);
            if (DOM.errorText && DOM.errorMessage) {
                DOM.errorText.textContent = message;
                DOM.errorMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (DOM.errorMessage) DOM.errorMessage.classList.add('hidden');
                }, duration);
            }
        }

        function showSuccess(message, duration = 3000) {
            console.log('成功:', message);
            if (DOM.successText && DOM.successMessage) {
                DOM.successText.textContent = message;
                DOM.successMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (DOM.successMessage) DOM.successMessage.classList.add('hidden');
                }, duration);
            }
        }

        function showInfo(message, duration = 5000) {
            console.log('信息:', message);
            if (DOM.infoText && DOM.infoMessage) {
                DOM.infoText.textContent = message;
                DOM.infoMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (DOM.infoMessage) DOM.infoMessage.classList.add('hidden');
                }, duration);
            }
        }

        function hideAllMessages() {
            if (DOM.searchStatus) DOM.searchStatus.classList.add('hidden');
            if (DOM.successMessage) DOM.successMessage.classList.add('hidden');
            if (DOM.infoMessage) DOM.infoMessage.classList.add('hidden');
            if (DOM.noResult) DOM.noResult.classList.add('hidden');
            if (DOM.errorMessage) DOM.errorMessage.classList.add('hidden');
        }

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightMatch(text, query, pathParts = null) {
            if (!query || typeof text !== 'string') return text;
            
            if (pathParts && shouldExcludeHighlight(pathParts)) {
                return text;
            }
            
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function shouldExcludeHighlight(pathParts) {
            if (!pathParts || pathParts.length === 0) return false;
            
            return CONFIG.excludeHighlightPaths.some(excludePath => {
                if (excludePath.length > pathParts.length) return false;
                for (let i = 0; i < excludePath.length; i++)
                    if (pathParts[i] !== excludePath[i]) return false;
                return true;
            });
        }

        // 生成唯一节点ID
        function generateNodeId(path) {
            return path.join('-').replace(/\[|\]/g, '');
        }

        // 切换节点展开/折叠状态
        function toggleNode(nodeId) {
            console.log('toggleNode called with:', nodeId);
            if (STATE.expandedNodes.has(nodeId)) {
                STATE.expandedNodes.delete(nodeId);
            } else {
                STATE.expandedNodes.add(nodeId);
            }
            
            // 重新渲染当前详情页
            if (STATE.currentItem) {
                console.log('Re-rendering with expanded nodes:', Array.from(STATE.expandedNodes));
                renderZhihuDetail(STATE.currentItem);
            }
        }

        // 初始化第一层标签
        function initRootTags(data) {
            console.log('初始化第一层标签...');
            if (!data || typeof data !== 'object' || data === null) return;
            
            const rootKeys = Object.keys(data);
            rootKeys.forEach((key, index) => {
                const colorIndex = index % CONFIG.tagColors.length;
                STATE.rootTags.set(key, CONFIG.tagColors[colorIndex]);
            });
            
            console.log('第一层标签初始化完成:', Array.from(STATE.rootTags.entries()));
        }

        // 获取第一层标签
        function getRootTag(path) {
            if (!path || path.length === 0) return '';
            
            const firstPart = path[0];
            if (STATE.rootTags.has(firstPart)) {
                const bgColor = STATE.rootTags.get(firstPart);
                return `<span class="source-tag ${bgColor} mr-2">${firstPart}</span>`;
            }
            
            return '';
        }

        // 格式化搜索结果内容
        function formatSearchResultContent(obj, query, pathParts) {
            try {
                if (obj === null || obj === undefined) return '';
                
                if (typeof obj === 'object') {
                    let contentParts = [];
                    
                    if (Array.isArray(obj)) {
                        contentParts.push('[');
                        for (let i = 0; i < Math.min(obj.length, 3); i++) {
                            const item = obj[i];
                            if (typeof item === 'string') {
                                contentParts.push(`"${item.length > 10 ? item.substring(0, 10) + '...' : item}"`);
                            } else if (typeof item === 'object' && item !== null) {
                                contentParts.push('{...}');
                            } else {
                                contentParts.push(String(item));
                            }
                        }
                        if (obj.length > 3) contentParts.push('...');
                        contentParts.push(']');
                        return contentParts.join(', ');
                    } else {
                        const keys = Object.keys(obj);
                        for (const key of keys) {
                            const value = obj[key];
                            let valueStr = '';
                            
                            if (typeof value === 'string') {
                                valueStr = value;
                            } else if (typeof value === 'object' && value !== null) {
                                valueStr = JSON.stringify(value);
                            } else {
                                valueStr = String(value);
                            }
                            
                            contentParts.push(`${key}: ${valueStr}`);
                        }
                        
                        let fullContent = contentParts.join('  ');
                        if (fullContent.length > CONFIG.searchResultMaxLength) {
                            fullContent = fullContent.substring(0, CONFIG.searchResultMaxLength) + '...';
                        }
                        
                        return highlightMatch(fullContent, query, pathParts);
                    }
                } else {
                    const text = String(obj);
                    const highlighted = highlightMatch(text, query, pathParts);
                    return text.length > CONFIG.searchResultMaxLength
                        ? `${highlighted.substring(0, CONFIG.searchResultMaxLength)}...`
                        : highlighted;
                }
            } catch (err) {
                console.error('格式化搜索结果失败:', err);
                return '';
            }
        }

        function isExcludedPath(path) {
            if (path.length < CONFIG.excludedPath.length) return false;
            for (let i = 0; i < CONFIG.excludedPath.length; i++)
                if (path[i] !== CONFIG.excludedPath[i]) return false;
            return true;
        }

        // 美化的数据渲染函数
        function renderDataAsHumanReadable(data, query, currentPath = [], level = 0) {
            try {
                const nodeId = generateNodeId(currentPath);
                const isExpanded = STATE.expandedNodes.has(nodeId) || level < 2; // 默认展开前两层
                console.log('renderDataAsHumanReadable - nodeId:', nodeId, 'isExpanded:', isExpanded);
                
                if (data === null || data === undefined) {
                    return `<span class="data-null">null</span>`;
                }
                
                // 基本类型处理
                if (typeof data !== 'object') {
                    let valueHtml, typeClass;
                    
                    if (typeof data === 'string') {
                        typeClass = 'data-string';
                        valueHtml = `"${highlightMatch(data, query, currentPath)}"`;
                    } else if (typeof data === 'number') {
                        typeClass = 'data-number';
                        valueHtml = String(data);
                    } else if (typeof data === 'boolean') {
                        typeClass = 'data-boolean';
                        valueHtml = String(data);
                    } else {
                        typeClass = '';
                        valueHtml = String(data);
                    }
                    
                    return `<span class="${typeClass}">${valueHtml}</span>`;
                }

                // 数组处理
                if (Array.isArray(data)) {
                    const arrayLength = data.length;
                    const arrayType = `<span class="data-type">Array[${arrayLength}]</span>`;
                    const expandBtn = `<div class="data-expand-btn" onclick="toggleNode('${nodeId}')">${isExpanded ? '-' : '+'}</div>`;
                    
                    let content = '';
                    if (isExpanded) {
                        if (arrayLength === 0) {
                            content = '<span class="text-gray-400">空数组</span>';
                        } else {
                            content = '<div class="data-indent">';
                            data.forEach((item, index) => {
                                const newPath = [...currentPath, `[${index}]`];
                                content += `
                                    <div class="py-1 border-b border-gray-50 last:border-0">
                                        <div class="flex items-start">
                                            <span class="text-gray-500 mr-2">${index}:</span>
                                            <div class="flex-1">${renderDataAsHumanReadable(item, query, newPath, level + 1)}</div>
                                        </div>
                                    </div>
                                `;
                            });
                            content += '</div>';
                        }
                    } else {
                        content = `<span class="text-gray-500">点击展开查看 ${arrayLength} 项内容</span>`;
                    }
                    
                    return `
                        <div class="data-array">
                            <div class="flex items-center">
                                ${expandBtn}
                                ${arrayType}
                            </div>
                            ${content}
                        </div>
                    `;
                }

                // 对象处理
                const keys = Object.keys(data);
                const objectType = `<span class="data-type">Object[${keys.length}]</span>`;
                const expandBtn = `<div class="data-expand-btn" onclick="toggleNode('${nodeId}')">${isExpanded ? '-' : '+'}</div>`;
                
                let content = '';
                if (isExpanded) {
                    if (keys.length === 0) {
                        content = '<span class="text-gray-400">空对象</span>';
                    } else {
                        content = '<div class="data-indent">';
                        keys.forEach(key => {
                            const value = data[key];
                            const newPath = [...currentPath, key];
                            const highlightedKey = highlightMatch(key, query, newPath);
                            
                            content += `
                                <div class="data-pair py-1 border-b border-gray-50 last:border-0">
                                    <div class="flex items-start">
                                        <span class="data-key mr-2">${highlightedKey}:</span>
                                        <div class="flex-1">${renderDataAsHumanReadable(value, query, newPath, level + 1)}</div>
                                    </div>
                                </div>
                            `;
                        });
                        content += '</div>';
                    }
                } else {
                    content = `<span class="text-gray-500">点击展开查看 ${keys.length} 个属性</span>`;
                }
                
                return `
                    <div class="data-object">
                        <div class="flex items-center">
                            ${expandBtn}
                            ${objectType}
                        </div>
                        ${content}
                    </div>
                `;
            } catch (err) {
                console.error('渲染数据失败:', err);
                return '<span class="text-red-500">数据渲染失败</span>';
            }
        }

        // 数据加载
        async function loadData() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    throw new Error('数据加载超时');
                }, CONFIG.fetchTimeout);

                const response = await fetch(CONFIG.dataUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error(`服务器响应错误 (${response.status})`);
                STATE.data = await response.json();

                initRootTags(STATE.data);
                showSuccess('数据源加载成功，可以开始搜索');
                
            } catch (err) {
                console.error('数据加载失败:', err);
                showError(`数据加载失败：${err.message}`);
            }
        }

        // 搜索功能 - 限制只能搜索到2层内容
        function searchData(obj, query, results, path, level) {
            try {
                if (level > CONFIG.maxDisplayLevel || isExcludedPath(path) || obj === null || typeof obj !== 'object') return;

                if (level === CONFIG.maxDisplayLevel) {
                    const currentName = path[path.length - 1];
                    const nameLower = currentName.toLowerCase();
                    const queryLower = query.toLowerCase();

                    let matchScore = 0, nameMatched = false, contentMatched = false;

                    if (nameLower.includes(queryLower)) {
                        nameMatched = true;
                        matchScore = nameLower === queryLower ? 10 : nameLower.startsWith(queryLower) ? 8 : 5;
                    }

                    if (!nameMatched && typeof obj === 'object') {
                        const contentStr = JSON.stringify(obj).toLowerCase();
                        if (contentStr.includes(queryLower)) {
                            contentMatched = true;
                            matchScore = 3;
                        }
                    }

                    if (nameMatched || contentMatched) {
                        const fullPath = path.join(' > ');
                        const content = formatSearchResultContent(obj, query, path);
                        
                        results.push({
                            id: Date.now() + Math.random(),
                            name: currentName,
                            highlightedName: highlightMatch(currentName, query, path),
                            content: content,
                            path: fullPath,
                            pathParts: [...path],
                            highlightedPath: path.map((p, index) => {
                                return highlightMatch(p, query, path.slice(0, index + 1));
                            }).join(' > '),
                            level: level,
                            fullData: obj,
                            matchScore: matchScore,
                            matchType: nameMatched ? 'name' : 'content'
                        });
                    }
                }

                if (level < CONFIG.maxDisplayLevel) {
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => {
                            const arrayItemName = `${path.length > 0 ? path[path.length - 1] : 'root'}[${index}]`;
                            searchData(item, query, results, [...path, arrayItemName], level + 1);
                        });
                    } else if (typeof obj === 'object' && obj !== null) {
                        for (const key in obj) {
                            if (obj.hasOwnProperty(key)) {
                                searchData(obj[key], query, results, [...path, key], level + 1);
                            }
                        }
                    }
                }
            } catch (err) {
                console.error(`搜索错误（路径：${path.join('/')}）:`, err);
            }
        }

        // 视图切换
        function switchToSearchView() {
            console.log('切换到搜索视图');
            try {
                document.getElementById('appBody').className = 'search-engine-bg';
                document.getElementById('searchLayout').classList.remove('hidden');
                document.getElementById('zhihuLayout').classList.add('hidden');
                
                STATE.currentView = 'search';
                STATE.currentItem = null;
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('切换视图时发生错误:', error);
                try {
                    window.location.hash = '#search';
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                } catch (backupError) {
                    console.error('备用方法也失败:', backupError);
                }
            }
        }

        function switchToZhihuView(item, scrollToTop = true) {
            console.log('切换到视图:', item.name);
            STATE.currentView = 'zhihu';
            STATE.currentItem = item;
            
            document.getElementById('appBody').className = 'zhihu-bg';
            document.getElementById('searchLayout').classList.add('hidden');
            document.getElementById('zhihuLayout').classList.remove('hidden');
            
            renderZhihuDetail(item);
            renderRelatedContent(item);
            
            if (scrollToTop) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 渲染搜索结果
        function renderSearchResults(results, query) {
            try {
                console.log('渲染搜索结果，共', results.length, '条');
                if (!DOM.searchResults) return;
                
                DOM.searchResults.innerHTML = '';
                
                if (results.length === 0) {
                    if (DOM.noResult) DOM.noResult.classList.remove('hidden');
                    return;
                }

                results.forEach((item, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item fade-in';
                    resultItem.style.animationDelay = `${index * 50}ms`;
                    
                    const rootTag = getRootTag(item.pathParts);
                    
                    resultItem.innerHTML = `
                        <div class="space-y-2">
                            <div class="flex items-start justify-between">
                                <h3 class="text-lg font-semibold text-primary">${rootTag}${item.highlightedName}</h3>
                                <span class="text-xs text-gray-400">${item.level}层</span>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">${item.content}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4 text-xs text-gray-400">
                                    <span>${item.matchType === 'name' ? '标题匹配' : '内容匹配'}</span>
                                    <span>匹配度: ${item.matchScore.toFixed(1)}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    resultItem.onclick = () => switchToZhihuView(item);
                    
                    DOM.searchResults.appendChild(resultItem);
                });
            } catch (err) {
                console.error('渲染搜索结果失败:', err);
                showError('渲染搜索结果失败');
            }
        }

        // 获取相关条目HTML（从“关于”字段提取，无则返回空）
        function getRelatedItemsHtml(currentItem, query) {
            try {
                // 1. 从当前数据的“关于”字段获取内容，判断是否存在且有效
                const aboutData = currentItem?.fullData?.关于;
                if (!aboutData) return ''; // 无“关于”字段，返回空
                
                // 2. 处理“关于”字段的不同格式（数组/字符串）
                let relatedList = [];
                if (Array.isArray(aboutData)) {
                    // 格式1：数组（如 ["条目1", "条目2"]）
                    relatedList = aboutData.filter(item => typeof item === 'string' && item.trim());
                } else if (typeof aboutData === 'string') {
                    // 格式2：字符串（如 “相关：条目1, 条目2”），简单分割为数组
                    relatedList = aboutData.replace(/^相关：|相关:/, '').split(',').map(item => item.trim()).filter(item => item);
                }
                
                // 3. 无有效相关内容，返回空
                if (relatedList.length === 0) return '';
                
                // 4. 生成带高亮的相关条目HTML
                return relatedList.map(item => {
                    const highlightedItem = highlightMatch(item, query); // 保留关键词高亮
                    return `
                        <span class="baike-related-item" onclick="searchByRelatedItem('${escape(item)}')">
                            ${highlightedItem}
                        </span>
                    `;
                }).join('');
            } catch (err) {
                console.error('处理“关于”字段失败:', err);
                return '';
            }
        }

        // 点击相关条目触发搜索
        function searchByRelatedItem(keyword) {
            DOM.searchInput.value = keyword;
            executeSearch();
            switchToSearchView(); // 跳回搜索页展示结果
        }

        // 渲染百度百科格式详情
        function renderZhihuDetail(item) {
            try {
                console.log('渲染百度百科详情:', item.name);
                if (!DOM.detailContent) return;
                
                const humanReadableData = renderDataAsHumanReadable(item.fullData, STATE.lastQuery, item.pathParts);
                const rootTag = getRootTag(item.pathParts);
                // 获取“关于”字段的相关内容
                const relatedHtml = getRelatedItemsHtml(item, STATE.lastQuery);
                
                // 检查数据是否为表格类型
                let infoTableHtml = '';
                const isTableType = typeof item.fullData === 'object' && 
                                   item.fullData !== null && 
                                   !Array.isArray(item.fullData) && 
                                   (item.fullData.表格 !== undefined || item.fullData.table !== undefined);
                
                if (isTableType) {
                    const entries = Object.entries(item.fullData);
                    if (entries.length > 0) {
                        infoTableHtml = '<table class="baike-info-table">';
                        entries.slice(0, 6).forEach(([key, value]) => {
                            const highlightedKey = highlightMatch(key, STATE.lastQuery);
                            const valueStr = typeof value === 'object' ? JSON.stringify(value) : String(value);
                            const highlightedValue = highlightMatch(valueStr.length > 50 ? valueStr.substring(0, 50) + '...' : valueStr, STATE.lastQuery);
                            infoTableHtml += `
                                <tr>
                                    <th class="baike-info-th">${highlightedKey}</th>
                                    <td class="baike-info-td">${highlightedValue}</td>
                                </tr>
                            `;
                        });
                        if (entries.length > 6) {
                            infoTableHtml += `
                                <tr>
                                    <th class="baike-info-th">更多属性</th>
                                    <td class="baike-info-td text-gray-500">
                                        共 ${entries.length} 个属性，详见下方详细内容
                                    </td>
                                </tr>
                            `;
                        }
                        infoTableHtml += '</table>';
                    }
                }
                
                DOM.detailContent.innerHTML = `
                    <div class="space-y-6">
                        <!-- 标题和标签 -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <h2 class="text-2xl font-bold text-gray-800">${item.highlightedName}</h2>
                            ${rootTag}
                        </div>
                        
                        <!-- 作者信息 -->
                        <div class="zhihu-author">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 rounded-full bg-zhihu-blue flex items-center justify-center text-white font-semibold">
                                    ${item.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-800">狐拾一之异界神域</div>
                                    <div class="text-xs text-zhihu-gray">发布于 ${new Date().toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 百度百科式基本信息栏 -->
                        ${infoTableHtml}
                        
                        <!-- 概述部分 -->
                        <div>
                            <h3 class="baike-section-title">概述</h3>
                            <p class="text-gray-700 leading-relaxed">
                                ${(() => {
                                    let introText = "关于" + item.highlightedName + "的基本介绍，包含核心特征和重要信息。";
                                    
                                    if (typeof item.fullData === 'object' && item.fullData !== null) {
                                        if (item.fullData.介绍 !== undefined && typeof item.fullData.介绍 === 'string') {
                                            introText = highlightMatch(item.fullData.介绍, STATE.lastQuery);
                                        } else if (item.fullData.description !== undefined && typeof item.fullData.description === 'string') {
                                            introText = highlightMatch(item.fullData.description, STATE.lastQuery);
                                        } else if (typeof item.fullData === 'string') {
                                            introText = highlightMatch(item.fullData.substring(0, 150), STATE.lastQuery);
                                            if (item.fullData.length > 150) introText += '...';
                                        }
                                    }
                                    
                                    return introText;
                                })()}
                            </p>
                        </div>
                        
                        <!-- 详细内容部分 -->
                        <div>
                            <h3 class="baike-section-title">详细内容</h3>
                            <div class="data-detail data-container">
                                ${humanReadableData}
                            </div>
                        </div>
                        
                        <!-- 相关条目：仅当有内容时渲染 -->
                        ${relatedHtml ? `
                            <div>
                                <h3 class="baike-section-title">相关条目</h3>
                                <div>
                                    ${relatedHtml}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- 操作区域 -->
                        <div class="zhihu-footer">
                            <div class="flex gap-6">
                                <div class="zhihu-action" onclick="switchToSearchView()">
                                    <i class="fa fa-arrow-left"></i>
                                    <span>返回</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('渲染失败:', err);
                if (DOM.detailContent) {
                    DOM.detailContent.innerHTML = '<div class="text-red-500 text-center py-8">数据渲染失败</div>';
                }
            }
        }

        // 渲染相关推荐
        function renderRelatedContent(currentItem) {
            try {
                console.log('渲染相关推荐');
                if (!DOM.relatedList) return;
                
                DOM.relatedList.innerHTML = '';
                
                const relatedItems = STATE.searchResults
                    .filter(item => item.id !== currentItem.id)
                    .slice(0, 5);

                relatedItems.forEach(item => {
                    const relatedItem = document.createElement('div');
                    relatedItem.className = 'zhihu-card p-4 cursor-pointer hover:bg-gray-50 transition-colors';
                    
                    const rootTag = getRootTag(item.pathParts);
                    
                    relatedItem.innerHTML = `
                        <div class="space-y-2">
                            <h4 class="font-medium text-gray-800 line-clamp-2">${rootTag}${item.highlightedName}</h4>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-zhihu-gray">${item.level}层 · ${item.matchType === 'name' ? '标题匹配' : '内容匹配'}</span>
                            </div>
                        </div>
                    `;

                    relatedItem.onclick = () => switchToZhihuView(item, true);
                    
                    DOM.relatedList.appendChild(relatedItem);
                });
            } catch (err) {
                console.error('渲染相关推荐失败:', err);
            }
        }

        // 执行搜索
        async function executeSearch() {
            try {
                console.log('执行搜索...');
                if (STATE.isSearching) {
                    console.log('正在搜索中，忽略重复请求');
                    return;
                }
                if (!STATE.data) {
                    showError('数据源尚未加载完成，请稍候');
                    return;
                }

                const query = document.getElementById('searchInput').value.trim();
                if (!query) {
                    hideAllMessages();
                    if (DOM.clearBtn) DOM.clearBtn.classList.add('hidden');
                    STATE.lastQuery = '';
                    return;
                }

                if (query === STATE.lastQuery) {
                    showError('已搜索过此关键词');
                    return;
                }

                STATE.isSearching = true;
                STATE.lastQuery = query;
                hideAllMessages();
                
                if (DOM.searchStatus && DOM.searchStatusText) {
                    DOM.searchStatus.classList.remove('hidden');
                    DOM.searchStatusText.textContent = '正在搜索...';
                }

                const startTime = Date.now();
                const results = [];
                searchData(STATE.data, query, results, [], 0);
                const searchTime = (Date.now() - startTime) / 1000;

                results.sort((a, b) => b.matchScore - a.matchScore);
                STATE.searchResults = results;

                if (DOM.resultCount && DOM.searchTime && DOM.resultStats) {
                    DOM.resultCount.textContent = results.length;
                    DOM.searchTime.textContent = searchTime.toFixed(2);
                    DOM.resultStats.classList.remove('hidden');
                }
                
                if (DOM.searchResults) {
                    DOM.searchResults.classList.remove('hidden');
                }
                
                renderSearchResults(results, query);

                if (results.length === 0 && DOM.noResult) {
                    DOM.noResult.classList.remove('hidden');
                }

            } catch (err) {
                console.error('搜索失败:', err);
                showError(`搜索失败：${err.message}`);
            } finally {
                STATE.isSearching = false;
                if (DOM.searchStatus) {
                    DOM.searchStatus.classList.add('hidden');
                }
                if (DOM.clearBtn) {
                    DOM.clearBtn.classList.remove('hidden');
                }
            }
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearBtn').classList.add('hidden');
            hideAllMessages();
            STATE.lastQuery = '';
        }

        // 初始化事件
        function initEvents() {
            console.log('初始化事件...');
            
            // 搜索框回车事件
            if (DOM.searchInput) {
                DOM.searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        executeSearch();
                        DOM.searchInput.blur();
                    }
                });
            }

            // 输入框变化
            if (DOM.searchInput && DOM.clearBtn) {
                DOM.searchInput.addEventListener('input', function() {
                    DOM.clearBtn.classList.toggle('hidden', !DOM.searchInput.value.trim());
                });
            }

            console.log('事件监听器初始化完成');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面DOM加载完成');
            
            initEvents();
            loadData();
            
        });

        // 全局函数
        window.switchToSearchView = switchToSearchView;
        window.executeSearch = executeSearch;
        window.clearSearch = clearSearch;
        window.toggleNode = toggleNode;
        window.searchByRelatedItem = searchByRelatedItem;

        console.log('JavaScript代码加载完成');
    </script>
</body>
</html>
